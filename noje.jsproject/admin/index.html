<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Eƒüitim Geli≈üim Takip Sistemi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
            display: flex;
            margin: 0;
            padding: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1e3a5f;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255,255,255,0.8);
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: #4CAF50;
            color: white;
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-arrow {
            margin-left: auto;
            font-size: 12px;
        }

        .nav-badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            width: calc(100% - 260px);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
            flex-shrink: 0;
        }

        .top-bar-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Search Section */
        .search-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            color: white;
            flex-shrink: 0;
        }

        .search-section h1 {
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .search-box {
            display: flex;
            gap: 10px;
            max-width: 800px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-btn {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #45a049;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            background: white;
            overflow-y: auto;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .content-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .content-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #333;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .card-subtitle {
            font-size: 14px;
            color: #666;
        }


        /* Login Screen */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin {
            background: #e74c3c;
            color: white;
        }

        .badge-teacher {
            background: #3498db;
            color: white;
        }

        .badge-student {
            background: #27ae60;
            color: white;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .pagination {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            align-items: center;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f5f5f5;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2>Admin Giri≈üi</h2>
        <div id="loginAlert"></div>
        <form id="loginForm">
            <div class="form-group">
                <label>E-posta</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>≈ûifre</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Giri≈ü Yap</button>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üìä Admin Panel</h2>
            </div>
            <div class="nav-item active" onclick="switchTab('dashboard', this)">
                <div class="nav-item-icon">üè†</div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchTab('users', this)">
                <div class="nav-item-icon">üë•</div>
                <span>Kullanƒ±cƒ±lar</span>
            </div>
            <div class="nav-item" onclick="switchTab('classrooms', this)">
                <div class="nav-item-icon">üè´</div>
                <span>Sƒ±nƒ±flar</span>
            </div>
            <div style="padding: 15px 20px; color: rgba(255,255,255,0.5); font-size: 12px; font-weight: 600; text-transform: uppercase; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
                ƒ∞√ßerik Hiyerar≈üisi
            </div>
            <div class="nav-item" onclick="switchTab('categories', this)">
                <div class="nav-item-icon">üìÅ</div>
                <span>1. Kategoriler</span>
            </div>
            <div class="nav-item" onclick="switchTab('groups', this)">
                <div class="nav-item-icon">üë•</div>
                <span>2. Gruplar</span>
            </div>
            <div class="nav-item" onclick="switchTab('lessons', this)">
                <div class="nav-item-icon">üìñ</div>
                <span>3. Dersler</span>
            </div>
            <div class="nav-item" onclick="switchTab('activities', this)">
                <div class="nav-item-icon">üìù</div>
                <span>4. Etkinlikler</span>
            </div>
            <div class="nav-item" onclick="switchTab('questions', this)">
                <div class="nav-item-icon">‚ùì</div>
                <span>5. Sorular</span>
            </div>
            <div style="padding: 15px 20px; color: rgba(255,255,255,0.5); font-size: 12px; font-weight: 600; text-transform: uppercase; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
                √ñƒürenci Takibi
            </div>
            <div class="nav-item" onclick="switchTab('statistics', this)">
                <div class="nav-item-icon">üìä</div>
                <span>ƒ∞statistikler</span>
            </div>
            <div class="nav-item" onclick="switchTab('teacher-notes', this)">
                <div class="nav-item-icon">üìù</div>
                <span>√ñƒüretmen Notlarƒ±</span>
            </div>
            <div style="padding: 15px 20px; color: rgba(255,255,255,0.5); font-size: 12px; font-weight: 600; text-transform: uppercase; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
                Medya Y√∂netimi
            </div>
            <div class="nav-item" onclick="switchTab('files', this)">
                <div class="nav-item-icon">üìé</div>
                <span>Dosyalar (GridFS)</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <span>Support</span>
                    <span>Subscribers</span>
                </div>
                <div class="top-bar-right">
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span id="adminName">Admin</span>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="logout()">√áƒ±kƒ±≈ü</button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <h1>Ne arƒ±yorsunuz?</h1>
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Ara..." id="globalSearch">
                    <button class="search-btn" onclick="performSearch()">Ara</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h2>Dashboard</h2>
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <h3 id="statUsers">0</h3>
                            <p>Toplam Kullanƒ±cƒ±</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTeachers">0</h3>
                            <p>√ñƒüretmenler</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statStudents">0</h3>
                            <p>√ñƒürenciler</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statClassrooms">0</h3>
                            <p>Sƒ±nƒ±flar</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statActivities">0</h3>
                            <p>Etkinlikler</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statCategories">0</h3>
                            <p>Kategoriler</p>
                        </div>
                    </div>

                    <div class="content-grid">
                        <div class="content-card" onclick="switchTab('users', document.querySelector('.nav-item:nth-child(2)'))">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Kullanƒ±cƒ±lar</div>
                            <div class="card-subtitle">Kullanƒ±cƒ±larƒ± y√∂netin</div>
                        </div>
                        <div class="content-card" onclick="switchTab('classrooms', document.querySelector('.nav-item:nth-child(3)'))">
                            <div class="card-icon">üè´</div>
                            <div class="card-title">Sƒ±nƒ±flar</div>
                            <div class="card-subtitle">Sƒ±nƒ±f y√∂netimi</div>
                        </div>
                        <div class="content-card" onclick="switchTab('categories', document.querySelector('.nav-item:nth-child(5)'))">
                            <div class="card-icon">üìÅ</div>
                            <div class="card-title">1. Kategoriler</div>
                            <div class="card-subtitle">Kategori y√∂netimi</div>
                        </div>
                        <div class="content-card" onclick="switchTab('groups', document.querySelector('.nav-item:nth-child(6)'))">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">2. Gruplar</div>
                            <div class="card-subtitle">Grup y√∂netimi</div>
                        </div>
                        <div class="content-card" onclick="switchTab('lessons', document.querySelector('.nav-item:nth-child(7)'))">
                            <div class="card-icon">üìñ</div>
                            <div class="card-title">3. Dersler</div>
                            <div class="card-subtitle">Ders y√∂netimi</div>
                        </div>
                        <div class="content-card" onclick="switchTab('activities', document.querySelector('.nav-item:nth-child(8)'))">
                            <div class="card-icon">üìù</div>
                            <div class="card-title">4. Etkinlikler</div>
                            <div class="card-subtitle">Etkinlik y√∂netimi</div>
                        </div>
                        <div class="content-card" onclick="switchTab('questions', document.querySelector('.nav-item:nth-child(9)'))">
                            <div class="card-icon">‚ùì</div>
                            <div class="card-title">5. Sorular</div>
                            <div class="card-subtitle">Soru y√∂netimi</div>
                        </div>
                        <div class="content-card" onclick="switchTab('statistics', document.querySelector('.nav-item:nth-child(11)'))">
                            <div class="card-icon">üìä</div>
                            <div class="card-title">ƒ∞statistikler</div>
                            <div class="card-subtitle">√ñƒürenci istatistikleri</div>
                        </div>
                        <div class="content-card" onclick="switchTab('teacher-notes', document.querySelector('.nav-item:nth-child(12)'))">
                            <div class="card-icon">üìù</div>
                            <div class="card-title">√ñƒüretmen Notlarƒ±</div>
                            <div class="card-subtitle">√ñƒürenci notlarƒ± y√∂netimi</div>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="users" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Kullanƒ±cƒ±lar</h2>
                        <button class="btn btn-success" onclick="openUserModal()">+ Yeni Kullanƒ±cƒ±</button>
                    </div>
                    <div id="usersAlert"></div>
                    <div class="table-container">
                        <div id="usersTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="usersPagination" class="pagination"></div>
                </div>

                <!-- Classrooms Tab -->
                <div id="classrooms" class="tab-content">
                    <h2>Sƒ±nƒ±flar</h2>
                    <div id="classroomsAlert"></div>
                    <div class="table-container">
                        <div id="classroomsTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="classroomsPagination" class="pagination"></div>
                </div>

                <!-- Activities Tab -->
                <div id="activities" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Etkinlikler</h2>
                        <button class="btn btn-success" onclick="openActivityModal()">+ Yeni Etkinlik</button>
                    </div>
                    <div id="activitiesAlert"></div>
                    <div class="table-container">
                        <div id="activitiesTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="activitiesPagination" class="pagination"></div>
                </div>

                <!-- Categories Tab -->
                <div id="categories" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Kategoriler</h2>
                        <button class="btn btn-success" onclick="openCategoryModal()">+ Yeni Kategori</button>
                    </div>
                    <div id="categoriesAlert"></div>
                    <div class="table-container">
                        <div id="categoriesTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="categoriesPagination" class="pagination"></div>
                </div>

                <!-- Groups Tab -->
                <div id="groups" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Gruplar</h2>
                        <button class="btn btn-success" onclick="openGroupModal()">+ Yeni Grup</button>
                    </div>
                    <div id="groupsAlert"></div>
                    <div class="table-container">
                        <div id="groupsTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="groupsPagination" class="pagination"></div>
                </div>

                <!-- Lessons Tab -->
                <div id="lessons" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Dersler</h2>
                        <button class="btn btn-success" onclick="openLessonModal()">+ Yeni Ders</button>
                    </div>
                    <div id="lessonsAlert"></div>
                    <div class="table-container">
                        <div id="lessonsTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="lessonsPagination" class="pagination"></div>
                </div>

                <!-- Questions Tab -->
                <div id="questions" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Sorular</h2>
                        <button class="btn btn-success" onclick="openQuestionModal()">+ Yeni Soru</button>
                    </div>
                    <div id="questionsAlert"></div>
                    <div class="table-container">
                        <div id="questionsTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="questionsPagination" class="pagination"></div>
                </div>

                <!-- Statistics Tab -->
                <div id="statistics" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>√ñƒürenci ƒ∞statistikleri</h2>
                    </div>
                    <div id="statisticsAlert"></div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">√ñƒüretmen Se√ßin:</label>
                        <select id="statisticsTeacherSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="">√ñƒüretmen se√ßin...</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">√ñƒürenci Se√ßin:</label>
                        <select id="statisticsStudentSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;" disabled>
                            <option value="">√ñnce √∂ƒüretmen se√ßin...</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">G√∂r√ºnt√ºleme:</label>
                        <select id="statisticsPeriodSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="daily">G√ºnl√ºk</option>
                            <option value="weekly">Haftalƒ±k (Son 7 G√ºn)</option>
                        </select>
                    </div>
                    <div id="statisticsContent" style="margin-top: 20px;">
                        <p style="color: #666; text-align: center; padding: 40px;">L√ºtfen √∂nce √∂ƒüretmen, sonra √∂ƒürenci se√ßin</p>
                    </div>
                </div>

                <!-- Teacher Notes Tab -->
                <div id="teacher-notes" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>√ñƒüretmen Notlarƒ±</h2>
                        <button class="btn btn-success" onclick="openTeacherNoteModal()">+ Yeni Not</button>
                    </div>
                    <div id="teacherNotesAlert"></div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">√ñƒüretmen Se√ßin:</label>
                        <select id="teacherNotesTeacherSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="">√ñƒüretmen se√ßin...</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">√ñƒürenci Se√ßin:</label>
                        <select id="teacherNotesStudentSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;" disabled>
                            <option value="">√ñnce √∂ƒüretmen se√ßin...</option>
                        </select>
                    </div>
                    <div id="teacherNotesContent" style="margin-top: 20px;">
                        <p style="color: #666; text-align: center; padding: 40px;">L√ºtfen √∂nce √∂ƒüretmen, sonra √∂ƒürenci se√ßin</p>
                    </div>
                </div>

                <!-- Files Tab -->
                <div id="files" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Dosyalar (GridFS)</h2>
                        <button class="btn btn-success" onclick="openFileUploadModal()">+ Dosya Y√ºkle</button>
                    </div>
                    <div id="filesAlert"></div>
                    <div class="table-container">
                        <div id="filesTable" class="loading">Y√ºkleniyor...</div>
                    </div>
                    <div id="filesPagination" class="pagination"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Yeni Kullanƒ±cƒ±</h2>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div id="userModalAlert"></div>
            <form id="userForm">
                <div class="form-group">
                    <label>Ad *</label>
                    <input type="text" id="userFirstName" required>
                </div>
                <div class="form-group">
                    <label>Soyad *</label>
                    <input type="text" id="userLastName" required>
                </div>
                <div class="form-group">
                    <label>E-posta</label>
                    <input type="email" id="userEmail">
                </div>
                <div class="form-group">
                    <label>≈ûifre</label>
                    <input type="password" id="userPassword">
                </div>
                <div class="form-group">
                    <label>Rol *</label>
                    <select id="userRole" required onchange="handleUserRoleChange()">
                        <option value="Student">√ñƒürenci</option>
                        <option value="Teacher">√ñƒüretmen</option>
                        <option value="Admin">Admin</option>
                        <option value="SuperAdmin">Super Admin</option>
                    </select>
                </div>
                <div id="studentClassroomSelection" class="form-group" style="display: none;">
                    <label>Sƒ±nƒ±f *</label>
                    <select id="studentClassroomSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Sƒ±nƒ±f se√ßin...</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kaydet</button>
                    <button type="button" class="btn" onclick="closeUserModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="activityModalTitle">Yeni Etkinlik</h2>
                <span class="close" onclick="closeActivityModal()">&times;</span>
            </div>
            <div id="activityModalAlert"></div>
            <form id="activityForm">
                <div class="form-group">
                    <label>Ba≈ülƒ±k *</label>
                    <input type="text" id="activityTitle" required>
                </div>
                <div class="form-group">
                    <label>Ders *</label>
                    <select id="activityLesson" required>
                        <option value="">Ders Se√ßin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tip *</label>
                    <select id="activityType" required>
                        <option value="Quiz">Quiz</option>
                        <option value="Drawing">√áizim</option>
                        <option value="Listening">Dinleme</option>
                        <option value="Visual">G√∂rsel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>S√ºre (Dakika)</label>
                    <input type="number" id="activityDuration" min="1" value="5">
                </div>
                <div class="form-group">
                    <label>Etkinlik Tipi *</label>
                    <select id="activityActivityType" required onchange="toggleReadingTextFields()">
                        <option value="Image">Resim</option>
                        <option value="Audio">Ses</option>
                        <option value="Video">Video</option>
                        <option value="Drawing">√áizim</option>
                        <option value="Text">Metin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Tipi</label>
                    <select id="activityMediaType">
                        <option value="None">Yok</option>
                        <option value="Audio">Ses</option>
                        <option value="Image">Resim</option>
                        <option value="Video">Video</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Depolama</label>
                    <select id="activityMediaStorage">
                        <option value="None">Yok</option>
                        <option value="GridFS">GridFS</option>
                        <option value="Base64">Base64</option>
                        <option value="URL">URL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Dosyalarƒ± (Ses, Video, Resim - Birden fazla ekleyebilirsiniz)</label>
                    <div id="selectedActivityMediaFiles" style="margin-bottom: 10px; min-height: 50px; border: 2px dashed #e0e0e0; border-radius: 6px; padding: 10px;">
                        <div style="color: #666; text-align: center; padding: 10px;">Hen√ºz dosya se√ßilmedi</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" onclick="openFileSelectModal('activity')" style="background: #667eea; color: white; flex: 1;">üìé Dosya Ekle</button>
                        <button type="button" class="btn" onclick="openFileUploadModal('activity')" style="background: #4CAF50; color: white; flex: 1;">‚¨ÜÔ∏è Yeni Dosya Y√ºkle</button>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        üí° Birden fazla dosya ekleyebilirsiniz (√∂rn: Ses + Video birlikte)
                    </small>
                </div>
                <div class="form-group">
                    <label>Medya URL (Alternatif - GridFS kullanƒ±yorsanƒ±z bo≈ü bƒ±rakƒ±n)</label>
                    <input type="text" id="activityMediaUrl" placeholder="http://...">
                </div>
                <!-- Okuma Metni Alanlarƒ± (activityType: 'Text' olduƒüunda) -->
                <div class="form-group" id="readingTextFields" style="display: none;">
                    <label>Okuma Metni Satƒ±rlarƒ± (Her satƒ±rƒ± ayrƒ± ayrƒ± girin)</label>
                    <div id="textLinesContainer" style="margin-bottom: 10px;">
                        <div class="text-line-item" style="display: flex; gap: 10px; margin-bottom: 8px;">
                            <input type="text" class="text-line-input" placeholder="√ñrn: Ahmet yaptƒ±." style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeTextLine(this)" style="padding: 8px 12px;">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="btn" onclick="addTextLine()" style="background: #667eea; color: white; width: 100%;">+ Satƒ±r Ekle</button>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        üí° Her satƒ±r okuma metninde ayrƒ± bir satƒ±r olarak g√∂sterilecektir
                    </small>
                </div>
                <div class="form-group" id="readingDurationField" style="display: none;">
                    <label>Okuma S√ºresi (Saniye)</label>
                    <input type="number" id="activityReadingDuration" min="1" placeholder="√ñrn: 60 (1 dakika)">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        üí° Okuma metni i√ßin √∂nerilen s√ºre (saniye cinsinden)
                    </small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kaydet</button>
                    <button type="button" class="btn" onclick="closeActivityModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="categoryModalTitle">Yeni Kategori</h2>
                <span class="close" onclick="closeCategoryModal()">&times;</span>
            </div>
            <div id="categoryModalAlert"></div>
            <form id="categoryForm">
                <div class="form-group">
                    <label>Kategori Adƒ± *</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label>A√ßƒ±klama</label>
                    <textarea id="categoryDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Akƒ±≈ü Tipi</label>
                    <select id="categoryFlowType">
                        <option value="Default">Default</option>
                        <option value="Linear">Linear</option>
                        <option value="ScoreBased">ScoreBased</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ƒ∞kon URL</label>
                    <input type="text" id="categoryIconUrl">
                </div>
                <div class="form-group">
                    <label>√ñƒürenci Se√ßin (Opsiyonel)</label>
                    <select id="categoryStudentSelect" onchange="handleCategoryStudentChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">√ñƒürenci se√ßin...</option>
                    </select>
                </div>
                <div id="categoryTeachersList" class="form-group" style="display: none; margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">√ñƒüretmenler:</label>
                    <div id="categoryTeachersContent" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #666; text-align: center; padding: 20px;">√ñƒürenci se√ßin</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kaydet</button>
                    <button type="button" class="btn" onclick="closeCategoryModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="groupModalTitle">Yeni Grup</h2>
                <span class="close" onclick="closeGroupModal()">&times;</span>
            </div>
            <div id="groupModalAlert"></div>
            <form id="groupForm">
                <div class="form-group">
                    <label>Grup Adƒ± *</label>
                    <input type="text" id="groupName" required>
                </div>
                <div class="form-group">
                    <label>Kategori *</label>
                    <select id="groupCategory" required>
                        <option value="">Kategori Se√ßin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sƒ±ra (Order Index)</label>
                    <input type="number" id="groupOrderIndex" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Grup Tipi *</label>
                    <select id="groupType" required>
                        <option value="Image">Resim</option>
                        <option value="Audio">Ses</option>
                        <option value="Video">Video</option>
                        <option value="Drawing">√áizim</option>
                        <option value="Text">Metin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Tipi</label>
                    <select id="groupMediaType">
                        <option value="None">Yok</option>
                        <option value="Audio">Ses</option>
                        <option value="Image">Resim</option>
                        <option value="Video">Video</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Depolama</label>
                    <select id="groupMediaStorage">
                        <option value="None">Yok</option>
                        <option value="GridFS">GridFS</option>
                        <option value="Base64">Base64</option>
                        <option value="URL">URL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Dosyalarƒ± (Ses, Video, Resim - Birden fazla ekleyebilirsiniz)</label>
                    <div id="selectedGroupMediaFiles" style="margin-bottom: 10px; min-height: 50px; border: 2px dashed #e0e0e0; border-radius: 6px; padding: 10px;">
                        <div style="color: #666; text-align: center; padding: 10px;">Hen√ºz dosya se√ßilmedi</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" onclick="openFileSelectModal('group')" style="background: #667eea; color: white; flex: 1;">üìé Dosya Ekle</button>
                        <button type="button" class="btn" onclick="openFileUploadModal('group')" style="background: #4CAF50; color: white; flex: 1;">‚¨ÜÔ∏è Yeni Dosya Y√ºkle</button>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        üí° Birden fazla dosya ekleyebilirsiniz (√∂rn: Ses + Video birlikte)
                    </small>
                </div>
                <div class="form-group">
                    <label>Medya URL (Alternatif - GridFS kullanƒ±yorsanƒ±z bo≈ü bƒ±rakƒ±n)</label>
                    <input type="text" id="groupMediaUrl" placeholder="http://...">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kaydet</button>
                    <button type="button" class="btn" onclick="closeGroupModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lesson Modal -->
    <div id="lessonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="lessonModalTitle">Yeni Ders</h2>
                <span class="close" onclick="closeLessonModal()">&times;</span>
            </div>
            <div id="lessonModalAlert"></div>
            <form id="lessonForm">
                <div class="form-group">
                    <label>Ders Ba≈ülƒ±ƒüƒ± *</label>
                    <input type="text" id="lessonTitle" required>
                </div>
                <div class="form-group">
                    <label>Grup *</label>
                    <select id="lessonGroup" required>
                        <option value="">Grup Se√ßin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Hedef ƒ∞√ßerik (Harf/√únite) *</label>
                    <input type="text" id="lessonTargetContent" required placeholder="√ñrn: A, B, 1, 2">
                </div>
                <div class="form-group">
                    <label>Sƒ±ra (Order Index)</label>
                    <input type="number" id="lessonOrderIndex" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Ders Tipi *</label>
                    <select id="lessonType" required>
                        <option value="Image">Resim</option>
                        <option value="Audio">Ses</option>
                        <option value="Video">Video</option>
                        <option value="Drawing">√áizim</option>
                        <option value="Text">Metin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Tipi</label>
                    <select id="lessonMediaType">
                        <option value="None">Yok</option>
                        <option value="Audio">Ses</option>
                        <option value="Image">Resim</option>
                        <option value="Video">Video</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Depolama</label>
                    <select id="lessonMediaStorage">
                        <option value="None">Yok</option>
                        <option value="GridFS">GridFS</option>
                        <option value="Base64">Base64</option>
                        <option value="URL">URL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Medya Dosyalarƒ± (Ses, Video, Resim - Birden fazla ekleyebilirsiniz)</label>
                    <div id="selectedLessonMediaFiles" style="margin-bottom: 10px; min-height: 50px; border: 2px dashed #e0e0e0; border-radius: 6px; padding: 10px;">
                        <div style="color: #666; text-align: center; padding: 10px;">Hen√ºz dosya se√ßilmedi</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" onclick="openFileSelectModal('lesson')" style="background: #667eea; color: white; flex: 1;">üìé Dosya Ekle</button>
                        <button type="button" class="btn" onclick="openFileUploadModal('lesson')" style="background: #4CAF50; color: white; flex: 1;">‚¨ÜÔ∏è Yeni Dosya Y√ºkle</button>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        üí° Birden fazla dosya ekleyebilirsiniz (√∂rn: Ses + Video birlikte)
                    </small>
                </div>
                <div class="form-group">
                    <label>Medya URL (Alternatif - GridFS kullanƒ±yorsanƒ±z bo≈ü bƒ±rakƒ±n)</label>
                    <input type="text" id="lessonMediaUrl" placeholder="http://...">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kaydet</button>
                    <button type="button" class="btn" onclick="closeLessonModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="questionModalTitle">Yeni Soru</h2>
                <span class="close" onclick="closeQuestionModal()">&times;</span>
            </div>
            <div id="questionModalAlert"></div>
            <form id="questionForm">
                <div class="form-group">
                    <label>Etkinlik veya Ders *</label>
                    <small style="color: #666; display: block; margin-bottom: 5px;">En az birini se√ßmelisiniz</small>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #666;">Etkinlik</label>
                            <select id="questionActivity">
                                <option value="">Etkinlik Se√ßin (Opsiyonel)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Ders</label>
                            <select id="questionLesson">
                                <option value="">Ders Se√ßin (Opsiyonel)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Soru Formatƒ± *</label>
                    <select id="questionFormat" required onchange="handleQuestionFormatChange()">
                        <optgroup label="Yeni Formatlar">
                            <option value="ONLY_TEXT">Sadece Metin</option>
                            <option value="AUDIO_TEXT">Ses + Metin</option>
                            <option value="IMAGE_TEXT">Resim + Metin</option>
                            <option value="AUDIO_IMAGE_TEXT">Ses + Resim + Metin</option>
                            <option value="DRAG_DROP">S√ºr√ºkle-Bƒ±rak</option>
                            <option value="KELIMEDE_HARF_BULMA">Kelimede Harf Bulma</option>
                        </optgroup>
                        <optgroup label="Eski Formatlar (Uyumluluk)">
                            <option value="Text">Metin (Eski)</option>
                            <option value="Audio">Ses (Eski)</option>
                            <option value="Image">Resim (Eski)</option>
                            <option value="Video">Video (Eski)</option>
                            <option value="Drawing">√áizim (Eski)</option>
                        </optgroup>
                    </select>
                    <small style="color: #666;">Soru tipine g√∂re form alanlarƒ± otomatik g√ºncellenir</small>
                </div>
                
                <div class="form-group">
                    <label>Aktivite ƒ∞smi (Admin Notu)</label>
                    <input type="text" id="questionAdminNote" placeholder="√ñrn: A a daki sesi hisset, B harfi √ßizimi vb." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <small style="color: #666;">Sadece admin panelinde g√∂r√ºn√ºr. Hangi soruyu eklediƒüinizi hatƒ±rlamak i√ßin kullanƒ±n.</small>
                </div>
                
                <!-- Dinamik Form Alanlarƒ± Container -->
                <div id="dynamicQuestionFields"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kaydet</button>
                    <button type="button" class="btn" onclick="closeQuestionModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- File Select Modal (Mini Question i√ßin) -->
    <div id="fileSelectModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Dosya Se√ß (Mini Question i√ßin)</h2>
                <span class="close" onclick="closeFileSelectModal()">&times;</span>
            </div>
            <div id="fileSelectModalAlert"></div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="fileSearchInput" placeholder="Dosya ara..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;" onkeyup="filterFiles()">
                </div>
                <div id="fileSelectList" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Dosya Y√ºkle (GridFS)</h2>
                <span class="close" onclick="closeFileUploadModal()">&times;</span>
            </div>
            <div id="fileUploadModalAlert"></div>
            <form id="fileUploadForm">
                <div class="form-group">
                    <label>Dosya Se√ß *</label>
                    <input type="file" id="fileInput" accept="image/*,video/*,audio/*" required>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Desteklenen formatlar: Resim (JPG, PNG, GIF, WEBP), Video (MP4, WEBM), Ses (MP3, WAV, OGG, M4A, AAC, FLAC)
                    </small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Y√ºkle</button>
                    <button type="button" class="btn" onclick="closeFileUploadModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/admin';
        const FILE_API_BASE = window.location.origin + '/api/files';
        let currentToken = localStorage.getItem('adminToken');
        let currentUser = null;
        let currentUserId = null;
        let currentPage = { users: 1, classrooms: 1 };
        let categories = [];
        let groups = [];
        let lessons = [];
        let currentActivityId = null;
        let currentPageActivities = 1;
        let selectedMediaFiles = []; // Se√ßilen medya dosyalarƒ± (array) - Question i√ßin
        let selectedActivityMediaFiles = []; // Activity i√ßin
        let selectedLessonMediaFiles = []; // Lesson i√ßin
        let selectedGroupMediaFiles = []; // Group i√ßin
        let currentFileSelectContext = 'question'; // Hangi form i√ßin dosya se√ßiliyor
        let selectedImageFile = null; // Soru i√ßin se√ßilen resim dosyasƒ±
        let selectedAudioFile = null; // Soru i√ßin se√ßilen ses dosyasƒ±
        let selectedVideoFile = null; // Soru i√ßin se√ßilen video dosyasƒ±

        // Soru Formatƒ± Strategy Mapping (Backend ile uyumlu)
        const questionFormatStrategies = {
            'ONLY_TEXT': {
                fields: ['questionText', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText'],
                showImage: false,
                showAudio: false
            },
            'AUDIO_TEXT': {
                fields: ['questionText', 'audioFile', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText', 'audioFile'],
                showImage: false,
                showAudio: true
            },
            'IMAGE_TEXT': {
                fields: ['questionText', 'imageFile', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText', 'imageFile'],
                showImage: true,
                showAudio: false
            },
            'AUDIO_IMAGE_TEXT': {
                fields: ['questionText', 'imageFile', 'audioFile', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText', 'imageFile', 'audioFile'],
                showImage: true,
                showAudio: true
            },
            'DRAG_DROP': {
                fields: ['questionText', 'contentObject', 'instruction'],
                requiredFields: ['questionText', 'contentObject'],
                showImage: false,
                showAudio: false
            },
            'KELIMEDE_HARF_BULMA': {
                fields: ['questionText', 'contentObject', 'correctAnswer', 'instruction'],
                requiredFields: ['questionText', 'contentObject', 'correctAnswer'],
                showImage: false,
                showAudio: false
            },
            // Eski formatlar i√ßin mapping
            'Text': {
                fields: ['questionText', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText'],
                showImage: false,
                showAudio: false
            },
            'Audio': {
                fields: ['questionText', 'audioFile', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText', 'audioFile'],
                showImage: false,
                showAudio: true
            },
            'Image': {
                fields: ['questionText', 'imageFile', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText', 'imageFile'],
                showImage: true,
                showAudio: false
            },
            'Video': {
                fields: ['questionText', 'videoFile', 'instruction', 'correctAnswer'],
                requiredFields: ['questionText', 'videoFile'],
                showImage: false,
                showAudio: false,
                showVideo: true
            },
            'Drawing': {
                fields: ['questionText', 'contentObject', 'instruction'],
                requiredFields: ['questionText', 'contentObject'],
                showImage: false,
                showAudio: false
            }
        };

        // Soru formatƒ± deƒüi≈ütiƒüinde form alanlarƒ±nƒ± g√ºncelle
        function handleQuestionFormatChange() {
            const questionFormat = document.getElementById('questionFormat')?.value;
            if (!questionFormat) return;

            const strategy = questionFormatStrategies[questionFormat];
            if (!strategy) {
                console.error('Bilinmeyen soru formatƒ±:', questionFormat);
                return;
            }

            const container = document.getElementById('dynamicQuestionFields');
            if (!container) return;

            // Container'ƒ± temizle
            container.innerHTML = '';

            // Her alan i√ßin form elementi olu≈ütur
            strategy.fields.forEach(fieldName => {
                const fieldHtml = createQuestionField(fieldName, strategy.requiredFields.includes(fieldName));
                container.insertAdjacentHTML('beforeend', fieldHtml);
            });

            // Dosya se√ßim alanlarƒ±nƒ± render et
            if (strategy.showImage) {
                renderImageFileSelector();
            }
            if (strategy.showAudio) {
                renderAudioFileSelector();
            }
            if (strategy.showVideo) {
                renderVideoFileSelector();
            }
        }

        // Soru alanƒ± olu≈ütur
        function createQuestionField(fieldName, required) {
            const requiredMark = required ? ' *' : '';
            
            switch (fieldName) {
                case 'questionText':
                    return `
                        <div class="form-group">
                            <label>Soru Metni${requiredMark}</label>
                            <textarea id="questionText" rows="3" placeholder='√ñrn: "Resme bak! Kelime i√ßinde "a" harfi var mƒ±?"' ${required ? 'required' : ''}></textarea>
                            <small style="color: #666;">Ekranda g√∂sterilecek soru metni</small>
                        </div>
                    `;
                
                case 'instruction':
                    return `
                        <div class="form-group">
                            <label>A√ßƒ±klama Metni (Opsiyonel)</label>
                            <textarea id="questionInstruction" rows="3" placeholder='√ñrn: "√ñnce "Sesi Hisset" butonuna tƒ±kla..."'></textarea>
                            <small style="color: #666;">Sorunun altƒ±nda g√∂sterilecek a√ßƒ±klama metni</small>
                        </div>
                    `;
                
                case 'correctAnswer':
                    return `
                        <div class="form-group">
                            <label>Doƒüru Cevap (Opsiyonel)</label>
                            <select id="questionCorrectAnswer">
                                <option value="">Se√ßin (Opsiyonel)...</option>
                                <option value="Evet">Evet (‚úì)</option>
                                <option value="Hayƒ±r">Hayƒ±r (‚úó)</option>
                            </select>
                            <small style="color: #666;">Kullanƒ±cƒ±nƒ±n se√ßmesi gereken doƒüru cevap</small>
                        </div>
                    `;
                
                case 'imageFile':
                    return `
                        <div class="form-group" id="imageFileField">
                            <label>üñºÔ∏è Resim Dosyasƒ±${requiredMark}</label>
                            <div id="selectedImageFile" style="margin-bottom: 10px; min-height: 50px; border: 2px dashed #e0e0e0; border-radius: 6px; padding: 10px;">
                                <div style="color: #666; text-align: center; padding: 10px;">Hen√ºz resim se√ßilmedi</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn" onclick="openFileSelectModalForImage()" style="background: #667eea; color: white; flex: 1;">üìé Resim Se√ß</button>
                                <button type="button" class="btn" onclick="openFileUploadModalForImage()" style="background: #4CAF50; color: white; flex: 1;">‚¨ÜÔ∏è Yeni Resim Y√ºkle</button>
                            </div>
                        </div>
                    `;
                
                case 'audioFile':
                    return `
                        <div class="form-group" id="audioFileField">
                            <label>üéµ Ses Dosyasƒ±${requiredMark}</label>
                            <div id="selectedAudioFile" style="margin-bottom: 10px; min-height: 50px; border: 2px dashed #e0e0e0; border-radius: 6px; padding: 10px;">
                                <div style="color: #666; text-align: center; padding: 10px;">Hen√ºz ses dosyasƒ± se√ßilmedi</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn" onclick="openFileSelectModalForAudio()" style="background: #667eea; color: white; flex: 1;">üìé Ses Se√ß</button>
                                <button type="button" class="btn" onclick="openFileUploadModalForAudio()" style="background: #4CAF50; color: white; flex: 1;">‚¨ÜÔ∏è Yeni Ses Y√ºkle</button>
                            </div>
                        </div>
                    `;
                
                case 'videoFile':
                    return `
                        <div class="form-group" id="videoFileField">
                            <label>üé¨ Video Dosyasƒ±${requiredMark}</label>
                            <div id="selectedVideoFile" style="margin-bottom: 10px; min-height: 50px; border: 2px dashed #e0e0e0; border-radius: 6px; padding: 10px;">
                                <div style="color: #666; text-align: center; padding: 10px;">Hen√ºz video dosyasƒ± se√ßilmedi</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn" onclick="openFileSelectModalForVideo()" style="background: #667eea; color: white; flex: 1;">üìé Video Se√ß</button>
                                <button type="button" class="btn" onclick="openFileUploadModalForVideo()" style="background: #4CAF50; color: white; flex: 1;">‚¨ÜÔ∏è Yeni Video Y√ºkle</button>
                            </div>
                        </div>
                    `;
                
                case 'contentObject':
                    const questionFormat = document.getElementById('questionFormat')?.value;
                    if (questionFormat === 'KELIMEDE_HARF_BULMA') {
                        return `
                            <div class="form-group">
                                <label>Kelimeler Listesi (JSON)${requiredMark}</label>
                                <textarea id="questionContentObject" rows="12" placeholder='[
  {
    "image": "elma.png",
    "word": "elma",
    "letters": ["e", "l", "m", "a"]
  },
  {
    "image": "ayakkabƒ±.png",
    "word": "ayakkabƒ±",
    "letters": ["a", "y", "a", "k", "k", "a", "b", "ƒ±"]
  }
]' ${required ? 'required' : ''}></textarea>
                                <small style="color: #666;">
                                    <strong>Kelimede Harf Bulma</strong> i√ßin JSON formatƒ±nda kelimeler listesi.<br>
                                    Her kelime i√ßin: image (resim dosya adƒ±), word (kelime), letters (harf dizisi) gerekli.<br>
                                    <strong>√ñrnek:</strong> [{"image": "elma.png", "word": "elma", "letters": ["e","l","m","a"]}]
                                </small>
                            </div>
                        `;
                    }
                    return `
                        <div class="form-group">
                            <label>ƒ∞√ßerik Objesi (JSON)${requiredMark}</label>
                            <textarea id="questionContentObject" rows="8" placeholder='{"items": [...], "targets": [...]}' ${required ? 'required' : ''}></textarea>
                            <small style="color: #666;">S√ºr√ºkle-bƒ±rak etkinliƒüi i√ßin JSON formatƒ±nda i√ßerik objesi</small>
                        </div>
                    `;
                
                default:
                    return '';
            }
        }

        // Resim dosyasƒ± se√ßici render (renderSelectedImageFile ile uyumlu)
        function renderImageFileSelector() {
            renderSelectedImageFile();
        }

        // Ses dosyasƒ± se√ßici render (renderSelectedAudioFile ile uyumlu)
        function renderAudioFileSelector() {
            renderSelectedAudioFile();
        }

        // Video dosyasƒ± se√ßici render (renderSelectedVideoFile ile uyumlu)
        function renderVideoFileSelector() {
            renderSelectedVideoFile();
        }

        // Helper function: Token kontrol√º ve Authorization header olu≈üturma
        function getAuthHeaders() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                console.error('Token bulunamadƒ±! L√ºtfen tekrar giri≈ü yapƒ±n.');
                logout();
                throw new Error('Token bulunamadƒ±');
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Helper function: API √ßaƒürƒ±sƒ± yaparken 401 hatasƒ± kontrol√º
        async function apiCall(url, options = {}) {
            try {
                const headers = getAuthHeaders();
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...headers,
                        ...(options.headers || {})
                    }
                });

                // 401 hatasƒ± geldiƒüinde logout yap
                if (response.status === 401) {
                    console.error('401 Unauthorized - Token ge√ßersiz veya s√ºresi dolmu≈ü');
                    showAlert('loginAlert', 'Oturum s√ºreniz dolmu≈ü. L√ºtfen tekrar giri≈ü yapƒ±n.', 'error');
                    logout();
                    throw new Error('Unauthorized');
                }

                return response;
            } catch (error) {
                if (error.message === 'Token bulunamadƒ±' || error.message === 'Unauthorized') {
                    throw error;
                }
                console.error('API √ßaƒürƒ±sƒ± hatasƒ±:', error);
                throw error;
            }
        }

        // DOM y√ºklendiƒüinde √ßalƒ±≈ü
        document.addEventListener('DOMContentLoaded', () => {
            // Check if already logged in
            if (currentToken) {
                checkAuth();
            }
            
            // Soru formatƒ± deƒüi≈üikliƒüini dinle
            const questionFormatSelect = document.getElementById('questionFormat');
            if (questionFormatSelect) {
                questionFormatSelect.addEventListener('change', handleQuestionFormatChange);
            }

            // Login form handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;

                    try {
                        const response = await fetch(`${API_BASE}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        const data = await response.json();
                        
                        console.log('üì• Login response:', data);
                        console.log('üì• User role:', data.user?.role);

                        if (data.success) {
                            // Admin kontrol√º yap
                            const userRole = data.user?.role;
                            console.log('üîç Role kontrol√º:', userRole, 'Admin:', userRole === 'Admin', 'SuperAdmin:', userRole === 'SuperAdmin');
                            
                            if (data.user && (userRole === 'Admin' || userRole === 'SuperAdmin')) {
                                currentToken = data.token;
                                currentUser = data.user;
                                localStorage.setItem('adminToken', currentToken);
                                localStorage.setItem('adminUser', JSON.stringify(data.user));
                                console.log('‚úÖ Admin giri≈üi ba≈üarƒ±lƒ±:', currentUser);
                                showAdminPanel();
                                showAlert('loginAlert', 'Giri≈ü ba≈üarƒ±lƒ±!', 'success');
                            } else {
                                console.error('‚ùå Admin rol√º yok:', userRole);
                                showAlert('loginAlert', `Bu panele sadece admin kullanƒ±cƒ±lar eri≈üebilir. Mevcut rol: ${userRole || 'tanƒ±msƒ±z'}`, 'error');
                            }
                        } else {
                            console.error('‚ùå Login ba≈üarƒ±sƒ±z:', data.message);
                            showAlert('loginAlert', data.message || 'Giri≈ü ba≈üarƒ±sƒ±z', 'error');
                        }
                    } catch (error) {
                        showAlert('loginAlert', 'Giri≈ü yapƒ±lƒ±rken hata olu≈ütu: ' + error.message, 'error');
                    }
                });
            }

            // User form handler
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('üìù User form submit edildi');
                    
                    const role = document.getElementById('userRole').value;
                    const userData = {
                        firstName: document.getElementById('userFirstName').value,
                        lastName: document.getElementById('userLastName').value,
                        email: document.getElementById('userEmail').value,
                        password: document.getElementById('userPassword').value,
                        role: role
                    };
                    
                    // Eƒüer √∂ƒürenci se√ßildiyse, sadece sƒ±nƒ±f ID'sini ekle (API'deki gibi)
                    if (role === 'Student') {
                        const classroomId = document.getElementById('studentClassroomSelect').value;
                        
                        if (!classroomId) {
                            showAlert('userModalAlert', 'L√ºtfen bir sƒ±nƒ±f se√ßin', 'error');
                            return;
                        }
                        
                        // API'deki gibi sadece sƒ±nƒ±f ID'si g√∂nderilecek
                        userData.classroomId = classroomId;
                    }

                    console.log('üì§ G√∂nderilen user data:', userData);

                    try {
                        const url = currentUserId ? `${API_BASE}/users/${currentUserId}` : `${API_BASE}/users`;
                        const method = currentUserId ? 'PUT' : 'POST';

                        console.log('üåê API isteƒüi:', { url, method, data: userData });

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(userData)
                        });

                        console.log('üì• API yanƒ±tƒ±:', response.status, response.statusText);

                        const data = await response.json();
                        console.log('üì• API data:', data);

                        if (data.success) {
                            showAlert('userModalAlert', data.message, 'success');
                            setTimeout(() => {
                                closeUserModal();
                                loadUsers(currentPage.users);
                                // Eƒüer √∂ƒüretmen eklendiyse, sƒ±nƒ±flar listesini de yenile
                                if (role === 'Teacher') {
                                    if (typeof loadClassrooms === 'function') {
                                        loadClassrooms(1);
                                    }
                                }
                            }, 1500);
                        } else {
                            showAlert('userModalAlert', data.message, 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå User form hatasƒ±:', error);
                        showAlert('userModalAlert', 'Hata: ' + error.message, 'error');
                    }
                });
            }

            // Activity form handler
            const activityForm = document.getElementById('activityForm');
            if (activityForm) {
                activityForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Etkinlik formu submit edildi');
                    
                    const titleEl = document.getElementById('activityTitle');
                    const lessonEl = document.getElementById('activityLesson');
                    const typeEl = document.getElementById('activityType');
                    const durationEl = document.getElementById('activityDuration');
                    
                    if (!titleEl || !lessonEl || !typeEl) {
                        showAlert('activityModalAlert', 'Form elementleri bulunamadƒ±', 'error');
                        console.error('Form elementleri bulunamadƒ±');
                        return;
                    }
                    
                    const activityData = {
                        title: titleEl.value.trim(),
                        lesson: lessonEl.value,
                        type: typeEl.value,
                        durationMinutes: parseInt(durationEl.value) || 5,
                        activityType: document.getElementById('activityActivityType') ? document.getElementById('activityActivityType').value : 'Text',
                        // Okuma metni satƒ±rlarƒ±
                        textLines: getTextLines(),
                        // Okuma s√ºresi
                        readingDuration: document.getElementById('activityReadingDuration') ? parseInt(document.getElementById('activityReadingDuration').value) || null : null,
                        mediaType: document.getElementById('activityMediaType') ? document.getElementById('activityMediaType').value : 'None',
                        mediaStorage: document.getElementById('activityMediaStorage') ? document.getElementById('activityMediaStorage').value : 'None',
                        // Geriye d√∂n√ºk uyumluluk i√ßin ilk dosyanƒ±n ID'sini mediaFileId'ye de kaydet
                        mediaFileId: selectedActivityMediaFiles.length > 0 ? selectedActivityMediaFiles[0].fileId : null,
                        // Yeni: Birden fazla medya dosyasƒ±
                        mediaFiles: selectedActivityMediaFiles.map((file, index) => ({
                            fileId: file.fileId,
                            mediaType: file.mediaType,
                            order: index
                        })),
                        mediaUrl: document.getElementById('activityMediaUrl') ? document.getElementById('activityMediaUrl').value.trim() || null : null
                    };

                    console.log('Etkinlik verisi:', activityData);

                    if (!activityData.title) {
                        showAlert('activityModalAlert', 'L√ºtfen bir ba≈ülƒ±k girin', 'error');
                        return;
                    }

                    if (!activityData.lesson) {
                        showAlert('activityModalAlert', 'L√ºtfen bir ders se√ßin', 'error');
                        return;
                    }

                    if (!currentToken) {
                        showAlert('activityModalAlert', 'Oturum s√ºresi dolmu≈ü. L√ºtfen tekrar giri≈ü yapƒ±n.', 'error');
                        logout();
                        return;
                    }

                    try {
                        const url = currentActivityId ? `${API_BASE}/activities/${currentActivityId}` : `${API_BASE}/activities`;
                        const method = currentActivityId ? 'PUT' : 'POST';

                        console.log('API isteƒüi g√∂nderiliyor:', { url, method, data: activityData });

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(activityData)
                        });

                        console.log('API yanƒ±tƒ±:', response.status, response.statusText);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('API hatasƒ±:', errorText);
                            try {
                                const errorData = JSON.parse(errorText);
                                showAlert('activityModalAlert', errorData.message || 'Bir hata olu≈ütu', 'error');
                            } catch {
                                showAlert('activityModalAlert', `Sunucu hatasƒ±: ${response.status} ${response.statusText}`, 'error');
                            }
                            return;
                        }

                        const data = await response.json();
                        console.log('API ba≈üarƒ±lƒ±:', data);

                        if (data.success) {
                            showAlert('activityModalAlert', data.message, 'success');
                            setTimeout(() => {
                                closeActivityModal();
                                if (typeof loadActivities === 'function') {
                                    loadActivities(currentPageActivities);
                                }
                            }, 1500);
                        } else {
                            showAlert('activityModalAlert', data.message || 'Etkinlik olu≈üturulamadƒ±', 'error');
                        }
                    } catch (error) {
                        console.error('Etkinlik ekleme hatasƒ±:', error);
                        showAlert('activityModalAlert', 'Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                    }
                });
            } else {
                console.error('activityForm elementi bulunamadƒ±!');
            }

            // Content Management Form Handlers - Modal'lardaki formlar i√ßin
            const categoryForm = document.getElementById('categoryForm');
            if (categoryForm) {
                categoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const categoryData = {
                        name: document.getElementById('categoryName').value.trim(),
                        description: document.getElementById('categoryDescription').value.trim(),
                        flowType: document.getElementById('categoryFlowType').value,
                        iconUrl: document.getElementById('categoryIconUrl').value.trim()
                    };

                    try {
                        const url = currentCategoryId ? `${API_BASE}/content/category/${currentCategoryId}` : `${API_BASE}/content/category`;
                        const method = currentCategoryId ? 'PUT' : 'POST';

                        console.log('Kategori g√∂nderiliyor:', categoryData);
                        console.log('URL:', url);
                        console.log('Method:', method);

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(categoryData)
                        });

                        console.log('Response status:', response.status);
                        console.log('Response ok:', response.ok);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('API hatasƒ±:', errorText);
                            try {
                                const errorData = JSON.parse(errorText);
                                showAlert('categoryModalAlert', errorData.message || errorData.error || 'Bir hata olu≈ütu', 'error');
                            } catch {
                                showAlert('categoryModalAlert', `Sunucu hatasƒ±: ${response.status} ${response.statusText}`, 'error');
                            }
                            return;
                        }

                        const data = await response.json();
                        console.log('API ba≈üarƒ±lƒ±:', data);
                        
                        if (data.success) {
                            showAlert('categoryModalAlert', data.message, 'success');
                            setTimeout(() => {
                                closeCategoryModal();
                                if (typeof loadCategories === 'function') loadCategories();
                            }, 1500);
                        } else {
                            showAlert('categoryModalAlert', data.message || 'Kategori olu≈üturulamadƒ±', 'error');
                        }
                    } catch (error) {
                        console.error('Kategori ekleme hatasƒ±:', error);
                        showAlert('categoryModalAlert', 'Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                    }
                });
            }

            const groupForm = document.getElementById('groupForm');
            if (groupForm) {
                groupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const groupData = {
                        name: document.getElementById('groupName').value.trim(),
                        category: document.getElementById('groupCategory').value,
                        orderIndex: parseInt(document.getElementById('groupOrderIndex').value) || 0,
                        groupType: document.getElementById('groupType').value,
                        mediaType: document.getElementById('groupMediaType').value,
                        mediaStorage: document.getElementById('groupMediaStorage').value,
                        // Geriye d√∂n√ºk uyumluluk i√ßin ilk dosyanƒ±n ID'sini mediaFileId'ye de kaydet
                        mediaFileId: selectedGroupMediaFiles.length > 0 ? selectedGroupMediaFiles[0].fileId : null,
                        // Yeni: Birden fazla medya dosyasƒ±
                        mediaFiles: selectedGroupMediaFiles.map((file, index) => ({
                            fileId: file.fileId,
                            mediaType: file.mediaType,
                            order: index
                        })),
                        mediaUrl: document.getElementById('groupMediaUrl') ? document.getElementById('groupMediaUrl').value.trim() || null : null
                    };

                    if (!groupData.category) {
                        showAlert('groupModalAlert', 'L√ºtfen bir kategori se√ßin', 'error');
                        return;
                    }

                    try {
                        const url = currentGroupId ? `${API_BASE}/content/group/${currentGroupId}` : `${API_BASE}/content/group`;
                        const method = currentGroupId ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(groupData)
                        });

                        const data = await response.json();
                        if (data.success) {
                            showAlert('groupModalAlert', data.message, 'success');
                            setTimeout(() => {
                                closeGroupModal();
                                if (typeof loadGroups === 'function') loadGroups();
                            }, 1500);
                        } else {
                            showAlert('groupModalAlert', data.message, 'error');
                        }
                    } catch (error) {
                        showAlert('groupModalAlert', 'Hata: ' + error.message, 'error');
                    }
                });
            }

            const lessonForm = document.getElementById('lessonForm');
            if (lessonForm) {
                lessonForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const lessonData = {
                        title: document.getElementById('lessonTitle').value.trim(),
                        group: document.getElementById('lessonGroup').value,
                        targetContent: document.getElementById('lessonTargetContent').value.trim(),
                        orderIndex: parseInt(document.getElementById('lessonOrderIndex').value) || 0,
                        lessonType: document.getElementById('lessonType').value,
                        mediaType: document.getElementById('lessonMediaType').value,
                        mediaStorage: document.getElementById('lessonMediaStorage').value,
                        // Geriye d√∂n√ºk uyumluluk i√ßin ilk dosyanƒ±n ID'sini mediaFileId'ye de kaydet
                        mediaFileId: selectedLessonMediaFiles.length > 0 ? selectedLessonMediaFiles[0].fileId : null,
                        // Yeni: Birden fazla medya dosyasƒ±
                        mediaFiles: selectedLessonMediaFiles.map((file, index) => ({
                            fileId: file.fileId,
                            mediaType: file.mediaType,
                            order: index
                        })),
                        mediaUrl: document.getElementById('lessonMediaUrl') ? document.getElementById('lessonMediaUrl').value.trim() || null : null
                    };

                    if (!lessonData.group) {
                        showAlert('lessonModalAlert', 'L√ºtfen bir grup se√ßin', 'error');
                        return;
                    }

                    try {
                        const url = currentLessonId ? `${API_BASE}/content/lesson/${currentLessonId}` : `${API_BASE}/content/lesson`;
                        const method = currentLessonId ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(lessonData)
                        });

                        const data = await response.json();
                        if (data.success) {
                            showAlert('lessonModalAlert', data.message, 'success');
                            setTimeout(() => {
                                closeLessonModal();
                                if (typeof loadLessons === 'function') loadLessons();
                            }, 1500);
                        } else {
                            showAlert('lessonModalAlert', data.message, 'error');
                        }
                    } catch (error) {
                        showAlert('lessonModalAlert', 'Hata: ' + error.message, 'error');
                    }
                });
            }

            // File Upload Form Handler
            const fileUploadForm = document.getElementById('fileUploadForm');
            if (fileUploadForm) {
                fileUploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('fileInput');
                    if (!fileInput.files || fileInput.files.length === 0) {
                        showAlert('fileUploadModalAlert', 'L√ºtfen bir dosya se√ßin', 'error');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);

                    try {
                        const file = fileInput.files[0];
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        console.log('üì§ Video y√ºkleme ba≈ülƒ±yor:', {
                            fileName: file.name,
                            fileSize: fileSizeMB + 'MB',
                            fileType: file.type,
                            context: currentFileSelectContext
                        });
                        
                        // Dosya boyutu kontrol√º (500MB limit)
                        if (file.size > 500 * 1024 * 1024) {
                            const errorMsg = `Dosya √ßok b√ºy√ºk! Maksimum dosya boyutu: 500MB (Se√ßilen dosya: ${fileSizeMB}MB)`;
                            console.error('‚ùå', errorMsg);
                            showAlert('fileUploadModalAlert', errorMsg, 'error');
                            return;
                        }
                        
                        showAlert('fileUploadModalAlert', `Dosya y√ºkleniyor... (${fileSizeMB}MB)`, 'info');
                        
                        console.log('üåê ƒ∞stek g√∂nderiliyor:', `${FILE_API_BASE}/upload`);
                        
                        const response = await fetch(`${FILE_API_BASE}/upload`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: formData
                        });

                        console.log('üì• Response alƒ±ndƒ±:', {
                            status: response.status,
                            statusText: response.statusText,
                            ok: response.ok,
                            headers: Object.fromEntries(response.headers.entries())
                        });

                        // Response durumunu kontrol et
                        if (!response.ok) {
                            let errorMessage = 'Dosya y√ºklenemedi';
                            try {
                                const errorData = await response.json();
                                console.error('‚ùå Hata response:', errorData);
                                errorMessage = errorData.message || errorData.error || errorMessage;
                            } catch (e) {
                                console.error('‚ùå JSON parse hatasƒ±:', e);
                                // JSON parse edilemiyorsa status text'i kullan
                                if (response.status === 413) {
                                    errorMessage = `Dosya √ßok b√ºy√ºk! Maksimum dosya boyutu: 500MB (Se√ßilen dosya: ${fileSizeMB}MB)`;
                                } else if (response.status === 400) {
                                    errorMessage = 'Ge√ßersiz dosya formatƒ± veya dosya tipi desteklenmiyor';
                                } else if (response.status === 401) {
                                    errorMessage = 'Yetkilendirme hatasƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.';
                                } else if (response.status === 500) {
                                    errorMessage = 'Sunucu hatasƒ±. L√ºtfen daha sonra tekrar deneyin.';
                                } else {
                                    errorMessage = `Sunucu hatasƒ±: ${response.status} ${response.statusText}`;
                                }
                            }
                            console.error('‚ùå Final hata mesajƒ±:', errorMessage);
                            showAlert('fileUploadModalAlert', errorMessage, 'error');
                            return;
                        }

                        const data = await response.json();
                        console.log('‚úÖ Ba≈üarƒ±lƒ± response:', data);

                        if (data.success) {
                            const fileUrl = `${window.location.origin}${data.file.url}`;
                            const fileId = data.file.fileId;
                            const contentType = data.file.contentType || '';
                            
                            // Yeni: Resim veya ses dosyasƒ± i√ßin √∂zel i≈ülem
                            if (currentFileSelectContext === 'question-image') {
                                if (!contentType.startsWith('image/')) {
                                    showAlert('fileUploadModalAlert', 'L√ºtfen bir resim dosyasƒ± y√ºkleyin!', 'error');
                                    return;
                                }
                                selectedImageFile = {
                                    fileId: fileId,
                                    mediaType: 'Image',
                                    contentType: contentType
                                };
                                renderSelectedImageFile();
                                closeFileUploadModal();
                                showAlert('questionModalAlert', '‚úÖ Resim ba≈üarƒ±yla y√ºklendi ve eklendi!', 'success');
                                return;
                            }
                            
                            if (currentFileSelectContext === 'question-audio') {
                                if (!contentType.startsWith('audio/')) {
                                    showAlert('fileUploadModalAlert', 'L√ºtfen bir ses dosyasƒ± y√ºkleyin!', 'error');
                                    return;
                                }
                                selectedAudioFile = {
                                    fileId: fileId,
                                    mediaType: 'Audio',
                                    contentType: contentType
                                };
                                renderSelectedAudioFile();
                                closeFileUploadModal();
                                showAlert('questionModalAlert', '‚úÖ Ses dosyasƒ± ba≈üarƒ±yla y√ºklendi ve eklendi!', 'success');
                                return;
                            }
                            
                            if (currentFileSelectContext === 'question-video') {
                                if (!contentType.startsWith('video/')) {
                                    showAlert('fileUploadModalAlert', 'L√ºtfen bir video dosyasƒ± y√ºkleyin!', 'error');
                                    return;
                                }
                                selectedVideoFile = {
                                    fileId: fileId,
                                    mediaType: 'Video',
                                    contentType: contentType
                                };
                                renderSelectedVideoFile();
                                closeFileUploadModal();
                                showAlert('questionModalAlert', '‚úÖ Video dosyasƒ± ba≈üarƒ±yla y√ºklendi ve eklendi!', 'success');
                                return;
                            }
                            
                            // Eski sistem (geriye uyumluluk)
                            showAlert('fileUploadModalAlert', 
                                `Dosya ba≈üarƒ±yla y√ºklendi!<br>File ID: ${fileId}<br>URL: <a href="${fileUrl}" target="_blank">${fileUrl}</a>`, 
                                'success');
                            
                            setTimeout(() => {
                                closeFileUploadModal();
                                loadFiles();
                            }, 2000);
                        } else {
                            showAlert('fileUploadModalAlert', data.message || 'Dosya y√ºklenemedi', 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå Dosya y√ºkleme hatasƒ± (catch):', error);
                        console.error('‚ùå Hata detaylarƒ±:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack,
                            fileName: fileInput.files[0]?.name,
                            fileSize: fileInput.files[0]?.size
                        });
                        
                        let errorMessage = 'Baƒülantƒ± hatasƒ±: ';
                        if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            errorMessage += 'Sunucuya baƒülanƒ±lamƒ±yor. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.';
                        } else if (error.message) {
                            errorMessage += error.message;
                        } else {
                            errorMessage += 'Bilinmeyen bir hata olu≈ütu.';
                        }
                        
                        showAlert('fileUploadModalAlert', errorMessage, 'error');
                    }
                });
            }

            const questionForm = document.getElementById('questionForm');
            if (questionForm) {
                questionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Soru formatƒ±nƒ± al (yeni sistem)
                    const questionFormat = document.getElementById('questionFormat')?.value;
                    const questionType = document.getElementById('questionType')?.value; // Eski sistem i√ßin
                    
                    // Soru metni ve a√ßƒ±klama
                    const questionText = document.getElementById('questionText')?.value?.trim();
                    const questionInstruction = document.getElementById('questionInstruction')?.value?.trim();
                    const correctAnswer = document.getElementById('questionCorrectAnswer')?.value?.trim() || null;
                    
                    if (!questionText) {
                        showAlert('questionModalAlert', 'L√ºtfen soru metnini girin', 'error');
                        return;
                    }
                    
                    // Resim, ses ve video dosyalarƒ±nƒ± hazƒ±rla
                    const imageFileId = selectedImageFile?.fileId || null;
                    const audioFileId = selectedAudioFile?.fileId || null;
                    const videoFileId = selectedVideoFile?.fileId || null;
                    
                    // Media files array'i olu≈ütur
                    const mediaFiles = [];
                    let order = 0;
                    if (imageFileId) {
                        mediaFiles.push({
                            fileId: imageFileId,
                            mediaType: 'Image',
                            order: order++
                        });
                    }
                    if (audioFileId) {
                        mediaFiles.push({
                            fileId: audioFileId,
                            mediaType: 'Audio',
                            order: order++
                        });
                    }
                    if (videoFileId) {
                        mediaFiles.push({
                            fileId: videoFileId,
                            mediaType: 'Video',
                            order: order++
                        });
                    }
                    
                    // Media type'ƒ± belirle
                    let finalMediaType = 'None';
                    if (imageFileId) {
                        finalMediaType = 'Image';
                    } else if (audioFileId) {
                        finalMediaType = 'Audio';
                    } else if (videoFileId) {
                        finalMediaType = 'Video';
                    }
                    
                    // ƒ∞√ßerik objesi (DRAG_DROP ve KELIMEDE_HARF_BULMA i√ßin)
                    let contentObject = null;
                    const contentObjectText = document.getElementById('questionContentObject')?.value?.trim();
                    if (contentObjectText) {
                        try {
                            const parsed = JSON.parse(contentObjectText);
                            // KELIMEDE_HARF_BULMA i√ßin words array'i olarak d√ºzenle
                            if (questionFormat === 'KELIMEDE_HARF_BULMA') {
                                contentObject = {
                                    words: Array.isArray(parsed) ? parsed : [parsed],
                                    targetLetter: correctAnswer || 'a'
                                };
                            } else {
                                contentObject = parsed;
                            }
                        } catch (e) {
                            showAlert('questionModalAlert', 'ƒ∞√ßerik objesi ge√ßerli bir JSON formatƒ±nda olmalƒ±dƒ±r', 'error');
                            return;
                        }
                    } else if (questionFormat === 'KELIMEDE_HARF_BULMA') {
                        showAlert('questionModalAlert', 'Kelimeler listesi zorunludur', 'error');
                        return;
                    }
                    
                    // Soru verisini olu≈ütur (yeni format destekli)
                    const activityId = document.getElementById('questionActivity').value;
                    const lessonId = document.getElementById('questionLesson').value;
                    
                    // En az birini se√ßmeli
                    if (!activityId && !lessonId) {
                        showAlert('questionModalAlert', 'L√ºtfen en az bir etkinlik veya ders se√ßin', 'error');
                        return;
                    }
                    
                    // Admin notu
                    const adminNote = document.getElementById('questionAdminNote')?.value?.trim() || null;
                    
                    const questionData = {
                        activity: activityId || null,
                        lesson: lessonId || null,
                        questionLevel: lessonId ? 'Lesson' : (activityId ? 'Activity' : null),
                        questionFormat: questionFormat || null, // Yeni format
                        questionType: questionFormat || questionType, // Format yoksa eski tipi kullan
                        correctAnswer: correctAnswer,
                        adminNote: adminNote, // Admin notu
                        mediaFileId: imageFileId || audioFileId || videoFileId || null,
                        mediaType: finalMediaType,
                        mediaStorage: (imageFileId || audioFileId || videoFileId) ? 'GridFS' : 'None',
                        mediaFiles: mediaFiles,
                        data: {
                            questionText: questionText,
                            instruction: questionInstruction || null,
                            audioFileId: audioFileId || null,
                            imageFileId: imageFileId || null,
                            videoFileId: videoFileId || null,
                            contentObject: contentObject || null
                        }
                    };

                    try {
                        const url = currentQuestionId ? `${API_BASE}/content/question/${currentQuestionId}` : `${API_BASE}/content/question`;
                        const method = currentQuestionId ? 'PUT' : 'POST';
                        
                        console.log('Soru verisi g√∂nderiliyor:', questionData);

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(questionData)
                        });

                        const data = await response.json();
                        if (data.success) {
                            showAlert('questionModalAlert', data.message || (currentQuestionId ? 'Soru ba≈üarƒ±yla g√ºncellendi' : 'Soru ba≈üarƒ±yla olu≈üturuldu'), 'success');
                            setTimeout(() => {
                                closeQuestionModal();
                                if (typeof loadQuestions === 'function') loadQuestions();
                            }, 1500);
                        } else {
                            const errorMessage = data.message || data.error || 'Bir hata olu≈ütu';
                            showAlert('questionModalAlert', errorMessage, 'error');
                            console.error('Soru kaydetme hatasƒ±:', data);
                        }
                    } catch (error) {
                        console.error('Soru kaydetme hatasƒ±:', error);
                        showAlert('questionModalAlert', 'Hata: ' + error.message, 'error');
                    }
                });
            }
        });

        async function checkAuth() {
            try {
                // √ñnce token'ƒ± kontrol et
                currentToken = localStorage.getItem('adminToken');
                if (!currentToken) {
                    console.log('Token bulunamadƒ±, logout yapƒ±lƒ±yor...');
                    logout();
                    return;
                }

                // Kullanƒ±cƒ± bilgisini localStorage'dan al
                const storedUser = localStorage.getItem('adminUser');
                if (!storedUser) {
                    console.log('Kullanƒ±cƒ± bilgisi bulunamadƒ±, logout yapƒ±lƒ±yor...');
                    logout();
                    return;
                }

                currentUser = JSON.parse(storedUser);

                // Admin kontrol√º yap
                if (!currentUser || (currentUser.role !== 'Admin' && currentUser.role !== 'SuperAdmin')) {
                    showAlert('loginAlert', 'Bu panele sadece admin kullanƒ±cƒ±lar eri≈üebilir.', 'error');
                    logout();
                    return;
                }

                // Token'ƒ±n ge√ßerliliƒüini kontrol et
                const response = await fetch(`${API_BASE}/statistics`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    showAdminPanel();
                } else if (response.status === 401) {
                    console.error('401 Unauthorized - Token ge√ßersiz veya s√ºresi dolmu≈ü');
                    showAlert('loginAlert', 'Oturum s√ºreniz dolmu≈ü. L√ºtfen tekrar giri≈ü yapƒ±n.', 'error');
                    logout();
                } else if (response.status === 403) {
                    showAlert('loginAlert', 'Bu panele sadece admin kullanƒ±cƒ±lar eri≈üebilir.', 'error');
                    logout();
                } else {
                    console.error(`Auth kontrol√º ba≈üarƒ±sƒ±z: ${response.status} ${response.statusText}`);
                    logout();
                }
            } catch (error) {
                console.error('Auth kontrol√º hatasƒ±:', error);
                logout();
            }
        }

        function showAdminPanel() {
            try {
                const loginScreen = document.getElementById('loginScreen');
                const adminPanel = document.getElementById('adminPanel');
                const adminName = document.getElementById('adminName');
                const userAvatar = document.getElementById('userAvatar');
                
                if (loginScreen) loginScreen.style.display = 'none';
                if (adminPanel) adminPanel.style.display = 'flex';
                if (currentUser && adminName) {
                    adminName.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                }
                if (currentUser && userAvatar) {
                    userAvatar.textContent = currentUser.firstName.charAt(0).toUpperCase();
                }
                
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                } else {
                    console.error('loadDashboard fonksiyonu bulunamadƒ±');
                }
            } catch (error) {
                console.error('showAdminPanel hatasƒ±:', error);
            }
        }

        function logout() {
            try {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                currentToken = null;
                currentUser = null;
                const loginScreen = document.getElementById('loginScreen');
                const adminPanel = document.getElementById('adminPanel');
                const loginForm = document.getElementById('loginForm');
                
                if (loginScreen) loginScreen.style.display = 'block';
                if (adminPanel) adminPanel.style.display = 'none';
                if (loginForm) loginForm.reset();
            } catch (error) {
                console.error('logout hatasƒ±:', error);
            }
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function switchTab(tabName, element) {
            try {
                // T√ºm nav item'larƒ± ve tab content'leri g√ºncelle
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                if (element) {
                    element.classList.add('active');
                }
                
                const tabContent = document.getElementById(tabName);
                if (!tabContent) {
                    console.error('Tab content bulunamadƒ±:', tabName);
                    return;
                }
                tabContent.classList.add('active');

                if (tabName === 'users') {
                    if (typeof loadUsers === 'function') {
                        loadUsers();
                    }
                } else if (tabName === 'classrooms') {
                    if (typeof loadClassrooms === 'function') {
                        loadClassrooms();
                    }
                } else if (tabName === 'activities') {
                    if (typeof loadActivities === 'function') {
                        loadActivities();
                    }
                } else if (tabName === 'categories') {
                    if (typeof loadCategories === 'function') {
                        loadCategories();
                    }
                } else if (tabName === 'groups') {
                    if (typeof loadGroups === 'function') {
                        loadGroups();
                    }
                } else if (tabName === 'lessons') {
                    if (typeof loadLessons === 'function') {
                        loadLessons();
                    }
                } else if (tabName === 'questions') {
                    if (typeof loadQuestions === 'function') {
                        loadQuestions();
                    }
                } else if (tabName === 'files') {
                    if (typeof loadFiles === 'function') {
                        loadFiles();
                    }
                } else if (tabName === 'statistics') {
                    if (typeof loadStatistics === 'function') {
                        loadStatistics();
                    }
                } else if (tabName === 'teacher-notes') {
                    if (typeof loadTeacherNotes === 'function') {
                        loadTeacherNotes();
                    }
                }
            } catch (error) {
                console.error('switchTab hatasƒ±:', error);
            }
        }

        function performSearch() {
            const searchTerm = document.getElementById('globalSearch').value;
            console.log('Arama:', searchTerm);
            // Arama fonksiyonunu buraya ekleyebilirsiniz
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/statistics`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('statUsers').textContent = data.data.users.total;
                    document.getElementById('statTeachers').textContent = data.data.users.teachers;
                    document.getElementById('statStudents').textContent = data.data.users.students;
                    document.getElementById('statClassrooms').textContent = data.data.classrooms.total;
                    document.getElementById('statActivities').textContent = data.data.content.activities;
                    document.getElementById('statCategories').textContent = data.data.content.categories;
                }
            } catch (error) {
                console.error('Dashboard y√ºklenemedi:', error);
            }
        }

        async function loadUsers(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/users?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentPage.users = page;
                    renderUsersTable(data.data, data.pagination);
                }
            } catch (error) {
                document.getElementById('usersTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderUsersTable(users, pagination) {
            // Mevcut kullanƒ±cƒ±nƒ±n rol√ºn√º kontrol et
            const currentUserRole = currentUser ? currentUser.role : null;
            const isSuperAdmin = currentUserRole === 'SuperAdmin';
            
            let html = '<table><thead><tr><th>Ad Soyad</th><th>E-posta</th><th>Rol</th><th>√ñƒüretmen</th><th>Olu≈üturulma</th><th>ƒ∞≈ülemler</th></tr></thead><tbody>';
            
            users.forEach(user => {
                const roleClass = `badge-${user.role.toLowerCase()}`;
                
                // √ñƒürenci i√ßin √∂ƒüretmen bilgisini, √∂ƒüretmen i√ßin sƒ±nƒ±f bilgisini g√∂ster
                let teacherInfo = '-';
                if (user.role === 'Student' && user.teacher) {
                    const teacherName = user.teacher.fullName || `${user.teacher.firstName || ''} ${user.teacher.lastName || ''}`.trim();
                    teacherInfo = teacherName || '-';
                } else if (user.role === 'Teacher' && user.classrooms && user.classrooms.length > 0) {
                    // √ñƒüretmen i√ßin sƒ±nƒ±f bilgisini g√∂ster
                    const classroomNames = user.classrooms.map(c => c.name).join(', ');
                    teacherInfo = `${user.classrooms.length} sƒ±nƒ±f (${classroomNames})`;
                }
                
                // üí° G√úVENLƒ∞K: Sil butonu kontrol√º
                // - Sadece SuperAdmin Admin veya SuperAdmin silebilir
                // - Normal Admin hi√ßbir admin silemez
                const canDelete = isSuperAdmin || (user.role !== 'Admin' && user.role !== 'SuperAdmin');
                const deleteButton = canDelete 
                    ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${user._id}')">Sil</button>`
                    : '';
                
                html += `
                    <tr>
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>${user.email || '-'}</td>
                        <td><span class="badge ${roleClass}">${user.role}</span></td>
                        <td>${teacherInfo}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editUser('${user._id}')">D√ºzenle</button>
                            ${deleteButton}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('usersTable').innerHTML = html;

            let paginationHtml = '';
            if (pagination.pages > 1) {
                paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadUsers(${pagination.page - 1})">√ñnceki</button>`;
                paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadUsers(${pagination.page + 1})">Sonraki</button>`;
            }
            document.getElementById('usersPagination').innerHTML = paginationHtml;
        }

        async function loadClassrooms(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/classrooms?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentPage.classrooms = page;
                    renderClassroomsTable(data.data, data.pagination);
                }
            } catch (error) {
                document.getElementById('classroomsTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderClassroomsTable(classrooms, pagination) {
            let html = '<table><thead><tr><th>Sƒ±nƒ±f Adƒ±</th><th>√ñƒüretmen</th><th>√ñƒürenci Sayƒ±sƒ±</th><th>Olu≈üturulma</th></tr></thead><tbody>';
            
            classrooms.forEach(classroom => {
                const teacher = classroom.teacher ? `${classroom.teacher.firstName} ${classroom.teacher.lastName}` : '-';
                html += `
                    <tr>
                        <td>${classroom.name}</td>
                        <td>${teacher}</td>
                        <td>${classroom.students ? classroom.students.length : 0}</td>
                        <td>${new Date(classroom.createdAt).toLocaleDateString('tr-TR')}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('classroomsTable').innerHTML = html;

            let paginationHtml = '';
            if (pagination.pages > 1) {
                paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadClassrooms(${pagination.page - 1})">√ñnceki</button>`;
                paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadClassrooms(${pagination.page + 1})">Sonraki</button>`;
            }
            document.getElementById('classroomsPagination').innerHTML = paginationHtml;
        }

        function openUserModal(userId = null) {
            try {
                currentUserId = userId;
                const modalTitle = document.getElementById('modalTitle');
                const userForm = document.getElementById('userForm');
                const userModal = document.getElementById('userModal');
                
                if (!modalTitle || !userForm || !userModal) {
                    console.error('User modal elementleri bulunamadƒ±');
                    alert('Modal elementleri bulunamadƒ±. Sayfayƒ± yenileyin.');
                    return;
                }
                
                modalTitle.textContent = userId ? 'Kullanƒ±cƒ± D√ºzenle' : 'Yeni Kullanƒ±cƒ±';
                userForm.reset();
                userModal.classList.add('active');
                
                // Varsayƒ±lan rol√º Student yap ve √∂ƒüretmen se√ßimini g√∂ster
                document.getElementById('userRole').value = 'Student';
                handleUserRoleChange();

                if (userId && typeof loadUserData === 'function') {
                    loadUserData(userId);
                } else {
                    // Yeni kullanƒ±cƒ± eklerken √∂ƒüretmen se√ßimini g√∂ster
                    handleUserRoleChange();
                }
            } catch (error) {
                console.error('openUserModal hatasƒ±:', error);
                alert('Modal a√ßƒ±lƒ±rken hata olu≈ütu: ' + error.message);
            }
        }

        async function loadUserData(userId) {
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const user = data.data;
                    document.getElementById('userFirstName').value = user.firstName;
                    document.getElementById('userLastName').value = user.lastName;
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userRole').value = user.role;
                    // Rol deƒüi≈üikliƒüini tetikle
                    handleUserRoleChange();
                }
            } catch (error) {
                showAlert('userModalAlert', 'Kullanƒ±cƒ± y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            document.getElementById('userForm').reset();
            document.getElementById('userModalAlert').innerHTML = '';
            // √ñƒüretmen ve sƒ±nƒ±f se√ßimlerini gizle
            document.getElementById('studentClassroomSelection').style.display = 'none';
            currentUserId = null;
        }

        // Rol deƒüi≈ütiƒüinde √∂ƒüretmen se√ßimini g√∂ster/gizle
        function handleUserRoleChange() {
            const role = document.getElementById('userRole').value;
            const classroomSelection = document.getElementById('studentClassroomSelection');
            
            if (role === 'Student') {
                classroomSelection.style.display = 'block';
                // T√ºm sƒ±nƒ±flarƒ± y√ºkle (API'deki gibi sƒ±nƒ±f ID'sine g√∂re ekleme)
                loadAllClassroomsForStudent();
            } else {
                classroomSelection.style.display = 'none';
            }
        }

        // √ñƒürenci i√ßin t√ºm sƒ±nƒ±flarƒ± y√ºkle (sƒ±nƒ±f ismi ve √∂ƒüretmen bilgisi ile)
        async function loadAllClassroomsForStudent() {
            try {
                const response = await fetch(`${API_BASE}/classrooms?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const classroomSelect = document.getElementById('studentClassroomSelect');
                if (!classroomSelect) return;
                
                classroomSelect.innerHTML = '<option value="">Sƒ±nƒ±f se√ßin...</option>';
                
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(classroom => {
                        const option = document.createElement('option');
                        option.value = classroom._id || classroom.id;
                        const teacherName = classroom.teacher ? 
                            `${classroom.teacher.firstName} ${classroom.teacher.lastName}` : 
                            '√ñƒüretmen bilgisi yok';
                        const studentCount = classroom.students ? classroom.students.length : 0;
                        option.textContent = `${classroom.name} - ${teacherName} (${studentCount} √∂ƒürenci)`;
                        classroomSelect.appendChild(option);
                    });
                } else {
                    classroomSelect.innerHTML = '<option value="">Sƒ±nƒ±f bulunamadƒ±</option>';
                    showAlert('userModalAlert', 'Hen√ºz sƒ±nƒ±f bulunmuyor. √ñnce bir √∂ƒüretmen olu≈üturun.', 'warning');
                }
            } catch (error) {
                console.error('Sƒ±nƒ±flar y√ºklenemedi:', error);
                showAlert('userModalAlert', 'Sƒ±nƒ±flar y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
                const classroomSelect = document.getElementById('studentClassroomSelect');
                if (classroomSelect) {
                    classroomSelect.innerHTML = '<option value="">Sƒ±nƒ±f y√ºklenemedi</option>';
                }
            }
        }

        async function editUser(userId) {
            openUserModal(userId);
        }

        async function deleteUser(userId) {
            if (!confirm('Bu kullanƒ±cƒ±yƒ± silmek istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('usersAlert', data.message, 'success');
                    loadUsers(currentPage.users);
                } else {
                    showAlert('usersAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('usersAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // ETKƒ∞NLƒ∞K Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        async function loadActivities(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/activities?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentPageActivities = page;
                    renderActivitiesTable(data.data, data.pagination);
                }
            } catch (error) {
                document.getElementById('activitiesTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderActivitiesTable(activities, pagination) {
            let html = '<table><thead><tr><th>Ba≈ülƒ±k</th><th>Tip</th><th>Ders</th><th>Kategori</th><th>S√ºre (dk)</th><th>Olu≈üturulma</th><th>ƒ∞≈ülemler</th></tr></thead><tbody>';
            
            activities.forEach(activity => {
                const lesson = activity.lesson || {};
                const group = lesson.group || {};
                const category = group.category || {};
                const typeLabels = {
                    'Drawing': '√áizim',
                    'Listening': 'Dinleme',
                    'Quiz': 'Quiz',
                    'Visual': 'G√∂rsel'
                };
                
                html += `
                    <tr>
                        <td>${activity.title}</td>
                        <td><span class="badge badge-teacher">${typeLabels[activity.type] || activity.type}</span></td>
                        <td>${lesson.title || '-'} (${lesson.targetContent || '-'})</td>
                        <td>${category.name || '-'}</td>
                        <td>${activity.durationMinutes || 5}</td>
                        <td>${new Date(activity.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editActivity('${activity._id}')">D√ºzenle</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteActivity('${activity._id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('activitiesTable').innerHTML = html;

            let paginationHtml = '';
            if (pagination.pages > 1) {
                paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadActivities(${pagination.page - 1})">√ñnceki</button>`;
                paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadActivities(${pagination.page + 1})">Sonraki</button>`;
            }
            document.getElementById('activitiesPagination').innerHTML = paginationHtml;
        }

        async function loadCategories() {
            try {
                console.log('Kategoriler y√ºkleniyor...');
                const response = await fetch(`${API_BASE}/categories`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    categories = data.data;
                    const select = document.getElementById('activityCategory');
                    if (select) {
                        select.innerHTML = '<option value="">Kategori Se√ßin</option>';
                        categories.forEach(cat => {
                            select.innerHTML += `<option value="${cat._id}">${cat.name}</option>`;
                        });
                    }
                    console.log('Kategoriler y√ºklendi:', categories.length);
                } else {
                    console.error('Kategoriler y√ºklenemedi:', data.message);
                    showAlert('activityModalAlert', 'Kategoriler y√ºklenemedi: ' + (data.message || 'Bilinmeyen hata'), 'error');
                }
            } catch (error) {
                console.error('Kategoriler y√ºklenemedi:', error);
                showAlert('activityModalAlert', 'Kategoriler y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        async function loadGroupsForCategory(categoryId) {
            if (!categoryId) {
                const groupSelect = document.getElementById('activityGroup');
                const lessonSelect = document.getElementById('activityLesson');
                if (groupSelect) groupSelect.innerHTML = '<option value="">√ñnce kategori se√ßin</option>';
                if (lessonSelect) lessonSelect.innerHTML = '<option value="">√ñnce grup se√ßin</option>';
                return;
            }
            try {
                console.log('Gruplar y√ºkleniyor, kategori:', categoryId);
                const response = await fetch(`${API_BASE}/categories/${categoryId}/groups`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    groups = data.data;
                    const select = document.getElementById('activityGroup');
                    if (select) {
                        select.innerHTML = '<option value="">Grup Se√ßin</option>';
                        groups.forEach(group => {
                            select.innerHTML += `<option value="${group._id}">${group.name}</option>`;
                        });
                    }
                    const lessonSelect = document.getElementById('activityLesson');
                    if (lessonSelect) lessonSelect.innerHTML = '<option value="">√ñnce grup se√ßin</option>';
                    console.log('Gruplar y√ºklendi:', groups.length);
                } else {
                    console.error('Gruplar y√ºklenemedi:', data.message);
                    showAlert('activityModalAlert', 'Gruplar y√ºklenemedi: ' + (data.message || 'Bilinmeyen hata'), 'error');
                }
            } catch (error) {
                console.error('Gruplar y√ºklenemedi:', error);
                showAlert('activityModalAlert', 'Gruplar y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        // T√ºm dersleri y√ºkle (etkinlik formu i√ßin)
        async function loadAllLessonsForActivity() {
            try {
                console.log('T√ºm dersler y√ºkleniyor...');
                // T√ºm dersleri getir (limit y√ºksek tutuldu)
                const response = await fetch(`${API_BASE}/content/lessons?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('activityLesson');
                    if (select) {
                        select.innerHTML = '<option value="">Ders Se√ßin</option>';
                        data.data.forEach(lesson => {
                            const groupName = lesson.group?.name || '';
                            const categoryName = lesson.group?.category?.name || '';
                            const displayText = `${lesson.title} (${lesson.targetContent})${categoryName ? ' - ' + categoryName : ''}${groupName ? ' - ' + groupName : ''}`;
                            select.innerHTML += `<option value="${lesson._id}">${displayText}</option>`;
                        });
                    }
                    console.log('Dersler y√ºklendi:', data.data.length);
                } else {
                    console.error('Dersler y√ºklenemedi:', data.message);
                    showAlert('activityModalAlert', 'Dersler y√ºklenemedi: ' + (data.message || 'Bilinmeyen hata'), 'error');
                }
            } catch (error) {
                console.error('Dersler y√ºklenemedi:', error);
                showAlert('activityModalAlert', 'Dersler y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function openActivityModal(activityId = null) {
            try {
                currentActivityId = activityId;
                const modalTitle = document.getElementById('activityModalTitle');
                const activityForm = document.getElementById('activityForm');
                const activityModal = document.getElementById('activityModal');
                
                if (!modalTitle || !activityForm || !activityModal) {
                    console.error('Activity modal elementleri bulunamadƒ±');
                    alert('Modal elementleri bulunamadƒ±. Sayfayƒ± yenileyin.');
                    return;
                }
                
                modalTitle.textContent = activityId ? 'Etkinlik D√ºzenle' : 'Yeni Etkinlik';
                activityForm.reset();
                activityModal.classList.add('active');
                
                // T√ºm dersleri y√ºkle
                loadAllLessonsForActivity();

                if (activityId && typeof loadActivityData === 'function') {
                    loadActivityData(activityId);
                }
            } catch (error) {
                console.error('openActivityModal hatasƒ±:', error);
                alert('Modal a√ßƒ±lƒ±rken hata olu≈ütu: ' + error.message);
            }
        }

        async function loadActivityData(activityId) {
            try {
                const response = await fetch(`${API_BASE}/activities/${activityId}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const activity = data.data;
                    document.getElementById('activityTitle').value = activity.title;
                    document.getElementById('activityType').value = activity.type;
                    document.getElementById('activityDuration').value = activity.durationMinutes || 5;
                    
                    // Sadece ders se√ßimi
                    if (activity.lesson && activity.lesson._id) {
                        // √ñnce t√ºm dersleri y√ºkle
                        await loadAllLessonsForActivity();
                        document.getElementById('activityLesson').value = activity.lesson._id;
                    }
                }
            } catch (error) {
                showAlert('activityModalAlert', 'Etkinlik y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
            document.getElementById('activityForm').reset();
            document.getElementById('activityModalAlert').innerHTML = '';
            currentActivityId = null;
            selectedActivityMediaFiles = [];
            if (typeof renderSelectedActivityMediaFiles === 'function') renderSelectedActivityMediaFiles();
        }

        async function editActivity(activityId) {
            openActivityModal(activityId);
        }

        async function deleteActivity(activityId) {
            if (!confirm('Bu etkinliƒüi silmek istediƒüinize emin misiniz? Baƒülƒ± sorular da silinecektir.')) return;

            try {
                const response = await fetch(`${API_BASE}/activities/${activityId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('activitiesAlert', data.message, 'success');
                    loadActivities(currentPageActivities);
                } else {
                    showAlert('activitiesAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('activitiesAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // Content Management Helper Functions
        async function loadContentData() {
            await Promise.all([
                loadCategoriesForContent(),
                loadGroupsForContent(),
                loadLessonsForContent(),
                loadActivitiesForContent()
            ]);
        }

        async function loadCategoriesForContent() {
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    categories = data.data;
                    const groupCategorySelect = document.getElementById('groupCategory');
                    if (groupCategorySelect) {
                        groupCategorySelect.innerHTML = '<option value="">Kategori Se√ßin</option>';
                        categories.forEach(cat => {
                            groupCategorySelect.innerHTML += `<option value="${cat._id}">${cat.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Kategoriler y√ºklenemedi:', error);
            }
        }

        async function loadGroupsForContent() {
            try {
                const response = await fetch(`${API_BASE}/content/groups`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    groups = data.data;
                    const lessonGroupSelect = document.getElementById('lessonGroup');
                    if (lessonGroupSelect) {
                        lessonGroupSelect.innerHTML = '<option value="">Grup Se√ßin</option>';
                        groups.forEach(group => {
                            lessonGroupSelect.innerHTML += `<option value="${group._id}">${group.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Gruplar y√ºklenemedi:', error);
            }
        }

        async function loadLessonsForContent() {
            try {
                const response = await fetch(`${API_BASE}/content/lessons`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    lessons = data.data;
                }
            } catch (error) {
                console.error('Dersler y√ºklenemedi:', error);
            }
        }

        async function loadActivitiesForContent() {
            try {
                // Etkinlikleri y√ºkle
                const activitiesResponse = await fetch(`${API_BASE}/activities?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const activitiesData = await activitiesResponse.json();
                if (activitiesData.success) {
                    const questionActivitySelect = document.getElementById('questionActivity');
                    if (questionActivitySelect) {
                        questionActivitySelect.innerHTML = '<option value="">Etkinlik Se√ßin (Opsiyonel)</option>';
                        activitiesData.data.forEach(activity => {
                            questionActivitySelect.innerHTML += `<option value="${activity._id}">${activity.title}</option>`;
                        });
                    }
                }
                
                // Dersleri y√ºkle
                const lessonsResponse = await fetch(`${API_BASE}/content/lessons`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const lessonsData = await lessonsResponse.json();
                if (lessonsData.success) {
                    const questionLessonSelect = document.getElementById('questionLesson');
                    if (questionLessonSelect) {
                        questionLessonSelect.innerHTML = '<option value="">Ders Se√ßin (Opsiyonel)</option>';
                        lessonsData.data.forEach(lesson => {
                            questionLessonSelect.innerHTML += `<option value="${lesson._id}">${lesson.title}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Etkinlikler veya dersler y√ºklenemedi:', error);
            }
        }

        // ======================================================================
        // KATEGORƒ∞ Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        let currentCategoryId = null;
        let currentPageCategories = 1;

        async function loadCategories(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    categories = data.data;
                    currentPageCategories = page;
                    renderCategoriesTable(categories);
                }
            } catch (error) {
                document.getElementById('categoriesTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderCategoriesTable(categories) {
            let html = '<table><thead><tr><th>Ad</th><th>A√ßƒ±klama</th><th>Akƒ±≈ü Tipi</th><th>Olu≈üturulma</th><th>ƒ∞≈ülemler</th></tr></thead><tbody>';
            
            categories.forEach(category => {
                html += `
                    <tr>
                        <td>${category.name}</td>
                        <td>${category.description || '-'}</td>
                        <td><span class="badge badge-teacher">${category.flowType || 'Default'}</span></td>
                        <td>${new Date(category.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editCategory('${category._id}')">D√ºzenle</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCategory('${category._id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('categoriesTable').innerHTML = html;
        }

        function openCategoryModal(categoryId = null) {
            currentCategoryId = categoryId;
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const form = document.getElementById('categoryForm');
            
            if (title) title.textContent = categoryId ? 'Kategori D√ºzenle' : 'Yeni Kategori';
            if (form) form.reset();
            if (modal) modal.classList.add('active');
            
            // √ñƒürenci listesini y√ºkle
            loadStudentsForCategory();

            if (categoryId) {
                loadCategoryData(categoryId);
            }
        }

        // Kategori modal'ƒ± i√ßin √∂ƒürenci listesini y√ºkle
        async function loadStudentsForCategory() {
            try {
                const response = await fetch(`${API_BASE}/users?role=Student&limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const studentSelect = document.getElementById('categoryStudentSelect');
                if (!studentSelect) return;
                
                studentSelect.innerHTML = '<option value="">√ñƒürenci se√ßin...</option>';
                
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student._id || student.id;
                        const studentName = `${student.firstName} ${student.lastName}`;
                        const teacherName = student.teacher ? ` (${student.teacher.fullName || `${student.teacher.firstName} ${student.teacher.lastName}`})` : '';
                        option.textContent = studentName + teacherName;
                        studentSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('√ñƒürenciler y√ºklenemedi:', error);
            }
        }

        async function loadCategoryData(categoryId) {
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    const category = data.data.find(c => c._id === categoryId);
                    if (category) {
                        document.getElementById('categoryName').value = category.name;
                        document.getElementById('categoryDescription').value = category.description || '';
                        document.getElementById('categoryFlowType').value = category.flowType || 'Default';
                        document.getElementById('categoryIconUrl').value = category.iconUrl || '';
                    }
                }
            } catch (error) {
                showAlert('categoryModalAlert', 'Kategori y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModalAlert').innerHTML = '';
            document.getElementById('categoryTeachersList').style.display = 'none';
            document.getElementById('categoryStudentSelect').innerHTML = '<option value="">√ñƒürenci se√ßin...</option>';
            currentCategoryId = null;
        }

        // Kategori modal'ƒ±nda √∂ƒürenci se√ßildiƒüinde t√ºm √∂ƒüretmenleri g√∂ster
        async function handleCategoryStudentChange() {
            const studentId = document.getElementById('categoryStudentSelect').value;
            const teachersList = document.getElementById('categoryTeachersList');
            const teachersContent = document.getElementById('categoryTeachersContent');
            
            if (!studentId) {
                teachersList.style.display = 'none';
                return;
            }
            
            // √ñƒürenci se√ßildiƒüinde t√ºm √∂ƒüretmenleri g√∂ster
            await loadAllTeachersForCategory();
        }

        // T√ºm √∂ƒüretmenleri y√ºkle ve g√∂ster
        async function loadAllTeachersForCategory() {
            try {
                const response = await fetch(`${API_BASE}/teachers`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const teachersList = document.getElementById('categoryTeachersList');
                const teachersContent = document.getElementById('categoryTeachersContent');
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    data.data.forEach(teacher => {
                        html += `
                            <div style="padding: 10px; background: white; border-radius: 5px; margin-bottom: 10px;">
                                <strong>${teacher.fullName || `${teacher.firstName} ${teacher.lastName}`}</strong>
                                ${teacher.email ? `<br><small style="color: #666;">${teacher.email}</small>` : ''}
                            </div>
                        `;
                    });
                    teachersContent.innerHTML = html;
                    teachersList.style.display = 'block';
                } else {
                    teachersContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">√ñƒüretmen bulunamadƒ±</p>';
                    teachersList.style.display = 'block';
                }
            } catch (error) {
                console.error('√ñƒüretmenler y√ºklenemedi:', error);
                const teachersContent = document.getElementById('categoryTeachersContent');
                teachersContent.innerHTML = '<p style="color: #d32f2f; text-align: center; padding: 20px;">√ñƒüretmenler y√ºklenirken hata olu≈ütu</p>';
                document.getElementById('categoryTeachersList').style.display = 'block';
            }
        }

        async function editCategory(categoryId) {
            openCategoryModal(categoryId);
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Bu kategoriyi silmek istediƒüinize emin misiniz? Bu kategoriye ait gruplar varsa silme i≈ülemi ba≈üarƒ±sƒ±z olacaktƒ±r.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/content/category/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('categoriesAlert', data.message, 'success');
                    setTimeout(() => {
                        loadCategories();
                    }, 1500);
                } else {
                    showAlert('categoriesAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('categoriesAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // GRUP Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        let currentGroupId = null;
        let currentPageGroups = 1;

        async function loadGroups(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/content/groups?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentPageGroups = page;
                    renderGroupsTable(data.data, data.pagination);
                }
            } catch (error) {
                document.getElementById('groupsTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderGroupsTable(groups, pagination) {
            let html = '<table><thead><tr><th>Ad</th><th>Kategori</th><th>Sƒ±ra</th><th>Olu≈üturulma</th><th>ƒ∞≈ülemler</th></tr></thead><tbody>';
            
            groups.forEach(group => {
                const category = group.category ? (group.category.name || group.category) : '-';
                html += `
                    <tr>
                        <td>${group.name}</td>
                        <td>${category}</td>
                        <td>${group.orderIndex || 0}</td>
                        <td>${new Date(group.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editGroup('${group._id}')">D√ºzenle</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteGroup('${group._id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('groupsTable').innerHTML = html;

            let paginationHtml = '';
            if (pagination && pagination.pages > 1) {
                paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadGroups(${pagination.page - 1})">√ñnceki</button>`;
                paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadGroups(${pagination.page + 1})">Sonraki</button>`;
            }
            document.getElementById('groupsPagination').innerHTML = paginationHtml;
        }

        function openGroupModal(groupId = null) {
            currentGroupId = groupId;
            const modal = document.getElementById('groupModal');
            const title = document.getElementById('groupModalTitle');
            const form = document.getElementById('groupForm');
            
            if (title) title.textContent = groupId ? 'Grup D√ºzenle' : 'Yeni Grup';
            if (form) form.reset();
            if (modal) modal.classList.add('active');

            loadCategoriesForContent();
            if (groupId) {
                loadGroupData(groupId);
            }
        }

        async function loadGroupData(groupId) {
            try {
                const response = await fetch(`${API_BASE}/content/groups`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    const group = data.data.find(g => g._id === groupId);
                    if (group) {
                        document.getElementById('groupName').value = group.name;
                        const categoryId = group.category._id || group.category;
                        document.getElementById('groupCategory').value = categoryId;
                        document.getElementById('groupOrderIndex').value = group.orderIndex || 0;
                    }
                }
            } catch (error) {
                showAlert('groupModalAlert', 'Grup y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('active');
            document.getElementById('groupForm').reset();
            document.getElementById('groupModalAlert').innerHTML = '';
            currentGroupId = null;
            selectedGroupMediaFiles = [];
            if (typeof renderSelectedGroupMediaFiles === 'function') renderSelectedGroupMediaFiles();
        }

        async function editGroup(groupId) {
            openGroupModal(groupId);
        }

        async function deleteGroup(groupId) {
            if (!confirm('Bu grubu silmek istediƒüinize emin misiniz? Bu gruba ait dersler varsa silme i≈ülemi ba≈üarƒ±sƒ±z olacaktƒ±r.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/content/group/${groupId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('groupsAlert', data.message, 'success');
                    setTimeout(() => {
                        loadGroups(currentPageGroups);
                    }, 1500);
                } else {
                    showAlert('groupsAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('groupsAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // DERS Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        let currentLessonId = null;
        let currentPageLessons = 1;

        async function loadLessons(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/content/lessons?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentPageLessons = page;
                    renderLessonsTable(data.data, data.pagination);
                }
            } catch (error) {
                document.getElementById('lessonsTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderLessonsTable(lessons, pagination) {
            let html = '<table><thead><tr><th>Ba≈ülƒ±k</th><th>Hedef ƒ∞√ßerik</th><th>Grup</th><th>Kategori</th><th>Sƒ±ra</th><th>Olu≈üturulma</th><th>ƒ∞≈ülemler</th></tr></thead><tbody>';
            
            lessons.forEach(lesson => {
                const group = lesson.group || {};
                const category = group.category || {};
                html += `
                    <tr>
                        <td>${lesson.title}</td>
                        <td>${lesson.targetContent}</td>
                        <td>${group.name || '-'}</td>
                        <td>${category.name || '-'}</td>
                        <td>${lesson.orderIndex || 0}</td>
                        <td>${new Date(lesson.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editLesson('${lesson._id}')">D√ºzenle</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteLesson('${lesson._id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('lessonsTable').innerHTML = html;

            let paginationHtml = '';
            if (pagination && pagination.pages > 1) {
                paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadLessons(${pagination.page - 1})">√ñnceki</button>`;
                paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadLessons(${pagination.page + 1})">Sonraki</button>`;
            }
            document.getElementById('lessonsPagination').innerHTML = paginationHtml;
        }

        function openLessonModal(lessonId = null) {
            currentLessonId = lessonId;
            const modal = document.getElementById('lessonModal');
            const title = document.getElementById('lessonModalTitle');
            const form = document.getElementById('lessonForm');
            
            if (title) title.textContent = lessonId ? 'Ders D√ºzenle' : 'Yeni Ders';
            if (form) form.reset();
            if (modal) modal.classList.add('active');

            loadGroupsForContent();
            if (lessonId) {
                loadLessonData(lessonId);
            }
        }

        async function loadLessonData(lessonId) {
            try {
                const response = await fetch(`${API_BASE}/content/lessons`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    const lesson = data.data.find(l => l._id === lessonId);
                    if (lesson) {
                        document.getElementById('lessonTitle').value = lesson.title;
                        const groupId = lesson.group._id || lesson.group;
                        document.getElementById('lessonGroup').value = groupId;
                        document.getElementById('lessonTargetContent').value = lesson.targetContent;
                        document.getElementById('lessonOrderIndex').value = lesson.orderIndex || 0;
                    }
                }
            } catch (error) {
                showAlert('lessonModalAlert', 'Ders y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function closeLessonModal() {
            document.getElementById('lessonModal').classList.remove('active');
            document.getElementById('lessonForm').reset();
            document.getElementById('lessonModalAlert').innerHTML = '';
            currentLessonId = null;
            selectedLessonMediaFiles = [];
            if (typeof renderSelectedLessonMediaFiles === 'function') renderSelectedLessonMediaFiles();
        }

        async function editLesson(lessonId) {
            openLessonModal(lessonId);
        }

        async function deleteLesson(lessonId) {
            if (!confirm('Bu dersi silmek istediƒüinize emin misiniz? Bu derse ait etkinlikler varsa silme i≈ülemi ba≈üarƒ±sƒ±z olacaktƒ±r.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/content/lesson/${lessonId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('lessonsAlert', data.message, 'success');
                    setTimeout(() => {
                        loadLessons(currentPageLessons);
                    }, 1500);
                } else {
                    showAlert('lessonsAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('lessonsAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // SORU Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        let currentQuestionId = null;
        let currentPageQuestions = 1;

        async function loadQuestions(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/content/questions?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentPageQuestions = page;
                    renderQuestionsTable(data.data, data.pagination);
                }
            } catch (error) {
                document.getElementById('questionsTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderQuestionsTable(questions, pagination) {
            let html = '<table><thead><tr><th>Soru Tipi</th><th>Aktivite ƒ∞smi (Admin)</th><th>Aktivite</th><th>Medya Tipi</th><th>Olu≈üturulma</th><th>ƒ∞≈ülemler</th></tr></thead><tbody>';
            
            questions.forEach(question => {
                const activity = question.activity || {};
                const typeLabels = {
                    'Image': 'Resim',
                    'Audio': 'Ses',
                    'Video': 'Video',
                    'Drawing': '√áizim',
                    'Text': 'Metin',
                    'ONLY_TEXT': 'Sadece Metin',
                    'AUDIO_TEXT': 'Ses + Metin',
                    'IMAGE_TEXT': 'Resim + Metin',
                    'AUDIO_IMAGE_TEXT': 'Ses + Resim + Metin',
                    'DRAG_DROP': 'S√ºr√ºkle-Bƒ±rak'
                };
                html += `
                    <tr>
                        <td><span class="badge badge-teacher">${typeLabels[question.questionType] || question.questionType}</span></td>
                        <td><strong style="color: #4CAF50;">${question.adminNote || '-'}</strong></td>
                        <td>${activity.title || '-'}</td>
                        <td>${question.mediaType || 'None'}</td>
                        <td>${new Date(question.createdAt).toLocaleDateString('tr-TR')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editQuestion('${question._id}')">D√ºzenle</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${question._id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('questionsTable').innerHTML = html;

            let paginationHtml = '';
            if (pagination && pagination.pages > 1) {
                paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadQuestions(${pagination.page - 1})">√ñnceki</button>`;
                paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadQuestions(${pagination.page + 1})">Sonraki</button>`;
            }
            document.getElementById('questionsPagination').innerHTML = paginationHtml;
        }

        function openQuestionModal(questionId = null) {
            currentQuestionId = questionId;
            const modal = document.getElementById('questionModal');
            const title = document.getElementById('questionModalTitle');
            const form = document.getElementById('questionForm');
            
            // Se√ßili dosyalarƒ± temizle
            selectedImageFile = null;
            selectedAudioFile = null;
            selectedVideoFile = null;
            selectedMediaFiles = [];
            
            if (title) title.textContent = questionId ? 'Soru D√ºzenle' : 'Yeni Soru';
            
            // Formu sƒ±fƒ±rla
            if (form) {
                form.reset();
            }
            
            // Varsayƒ±lan formatƒ± ayarla (sadece yeni soru i√ßin)
            if (!questionId) {
                const formatSelect = document.getElementById('questionFormat');
                if (formatSelect) {
                    formatSelect.value = 'ONLY_TEXT'; // Varsayƒ±lan format
                    handleQuestionFormatChange(); // Form alanlarƒ±nƒ± olu≈ütur
                }
            }
            
            if (modal) modal.classList.add('active');

            // Etkinlik ve dersleri y√ºkle
            loadActivitiesForContent().then(() => {
                // Soru d√ºzenleme modunda, verileri y√ºkle
                if (questionId) {
                    loadQuestionData(questionId);
                }
            });
        }

        async function loadQuestionData(questionId) {
            try {
                const response = await fetch(`${API_BASE}/content/questions`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    const question = data.data.find(q => q._id === questionId);
                    if (question) {
                        const activityId = question.activity ? (question.activity._id || question.activity) : null;
                        const lessonId = question.lesson ? (question.lesson._id || question.lesson) : null;
                        
                        // Etkinlik ve ders se√ßimlerini y√ºkle
                        if (activityId) {
                            document.getElementById('questionActivity').value = activityId;
                        }
                        if (lessonId) {
                            document.getElementById('questionLesson').value = lessonId;
                        }
                        
                        // Question format ve type
                        const questionFormat = question.questionFormat || question.questionType || 'ONLY_TEXT';
                        const formatSelect = document.getElementById('questionFormat');
                        if (formatSelect) {
                            formatSelect.value = questionFormat;
                            handleQuestionFormatChange(); // Form alanlarƒ±nƒ± olu≈ütur
                        }
                        document.getElementById('questionType').value = question.questionType || questionFormat;
                        document.getElementById('questionCorrectAnswer').value = question.correctAnswer || '';
                        
                        // Admin notu
                        const adminNoteInput = document.getElementById('questionAdminNote');
                        if (adminNoteInput) {
                            adminNoteInput.value = question.adminNote || '';
                        }
                        
                        // Soru metni ve a√ßƒ±klama
                        if (question.data) {
                            const questionTextInput = document.getElementById('questionText');
                            const questionInstructionInput = document.getElementById('questionInstruction');
                            if (questionTextInput) {
                                questionTextInput.value = question.data.questionText || '';
                            }
                            if (questionInstructionInput) {
                                questionInstructionInput.value = question.data.instruction || '';
                            }
                            
                            // Ses dosyasƒ± ID'si
                            if (question.data.audioFileId) {
                                selectedAudioFile = {
                                    fileId: question.data.audioFileId,
                                    mediaType: 'Audio',
                                    contentType: 'audio/mpeg'
                                };
                                renderSelectedAudioFile();
                            }
                            
                            // Video dosyasƒ± ID'si
                            if (question.data.videoFileId) {
                                selectedVideoFile = {
                                    fileId: question.data.videoFileId,
                                    mediaType: 'Video',
                                    contentType: 'video/mp4'
                                };
                                renderSelectedVideoFile();
                            }
                            
                            // ƒ∞√ßerik objesi (DRAG_DROP i√ßin)
                            if (question.data.contentObject) {
                                const contentObjectInput = document.getElementById('questionContentObject');
                                if (contentObjectInput) {
                                    contentObjectInput.value = JSON.stringify(question.data.contentObject, null, 2);
                                }
                            }
                        }
                        
                        // Resim dosyasƒ±
                        if (question.mediaFileId && question.mediaType === 'Image') {
                            selectedImageFile = {
                                fileId: question.mediaFileId,
                                mediaType: 'Image',
                                contentType: 'image/jpeg'
                            };
                            renderSelectedImageFile();
                        }
                        // Video dosyasƒ±
                        if (question.mediaFileId && question.mediaType === 'Video') {
                            selectedVideoFile = {
                                fileId: question.mediaFileId,
                                mediaType: 'Video',
                                contentType: 'video/mp4'
                            };
                            renderSelectedVideoFile();
                        }
                        
                        // Media files array (birden fazla dosya i√ßin)
                        if (question.mediaFiles && Array.isArray(question.mediaFiles) && question.mediaFiles.length > 0) {
                            selectedMediaFiles = question.mediaFiles;
                            // ƒ∞lk resim, ses ve video dosyasƒ±nƒ± se√ß
                            const imageFile = question.mediaFiles.find(f => f.mediaType === 'Image');
                            const audioFile = question.mediaFiles.find(f => f.mediaType === 'Audio');
                            const videoFile = question.mediaFiles.find(f => f.mediaType === 'Video');
                            if (imageFile) {
                                selectedImageFile = {
                                    fileId: imageFile.fileId,
                                    mediaType: 'Image',
                                    contentType: 'image/jpeg'
                                };
                                renderSelectedImageFile();
                            }
                            if (audioFile) {
                                selectedAudioFile = {
                                    fileId: audioFile.fileId,
                                    mediaType: 'Audio',
                                    contentType: 'audio/mpeg'
                                };
                                renderSelectedAudioFile();
                            }
                            if (videoFile) {
                                selectedVideoFile = {
                                    fileId: videoFile.fileId,
                                    mediaType: 'Video',
                                    contentType: 'video/mp4'
                                };
                                renderSelectedVideoFile();
                            }
                        }
                    } else {
                        showAlert('questionModalAlert', 'Soru bulunamadƒ±', 'error');
                    }
                } else {
                    showAlert('questionModalAlert', data.message || 'Soru y√ºklenemedi', 'error');
                }
            } catch (error) {
                console.error('Soru y√ºkleme hatasƒ±:', error);
                showAlert('questionModalAlert', 'Soru y√ºklenirken hata: ' + error.message, 'error');
            }
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.remove('active');
            document.getElementById('questionForm').reset();
            document.getElementById('questionModalAlert').innerHTML = '';
            document.getElementById('dynamicQuestionFields').innerHTML = '';
            selectedImageFile = null;
            selectedAudioFile = null;
            selectedVideoFile = null;
            currentQuestionId = null;
        }

        async function editQuestion(questionId) {
            openQuestionModal(questionId);
        }

        async function deleteQuestion(questionId) {
            if (!confirm('Bu soruyu silmek istediƒüinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/content/question/${questionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('questionsAlert', data.message, 'success');
                    setTimeout(() => {
                        loadQuestions(currentPageQuestions);
                    }, 1500);
                } else {
                    showAlert('questionsAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('questionsAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // DOSYA Y√ñNETƒ∞Mƒ∞ (GridFS)
        // ======================================================================

        async function loadFiles(page = 1) {
            try {
                const response = await fetch(`${FILE_API_BASE}?page=${page}&limit=20`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderFilesTable(data.files, data.pagination);
                } else {
                    document.getElementById('filesTable').innerHTML = `<div class="alert alert-error">${data.message || 'Dosyalar y√ºklenemedi'}</div>`;
                }
            } catch (error) {
                console.error('Dosya y√ºkleme hatasƒ±:', error);
                document.getElementById('filesTable').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderFilesTable(files, pagination) {
            if (!files || files.length === 0) {
                document.getElementById('filesTable').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>Hen√ºz dosya y√ºklenmemi≈ü.</p>
                    </div>
                `;
                document.getElementById('filesPagination').innerHTML = '';
                return;
            }

            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Dosya Adƒ±</th>
                            <th>Tip</th>
                            <th>Boyut</th>
                            <th>File ID</th>
                            <th>URL</th>
                            <th>Y√ºkleme Tarihi</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            files.forEach(file => {
                const fileId = file._id || file.fileId;
                const fileUrl = `${window.location.origin}/api/files/${fileId}`;
                const sizeKB = (file.length / 1024).toFixed(2);
                const sizeMB = (file.length / 1024 / 1024).toFixed(2);
                const size = file.length > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;
                const uploadDate = file.uploadDate ? new Date(file.uploadDate).toLocaleString('tr-TR') : 'Bilinmiyor';

                // Dosya tipine g√∂re √∂nizleme butonu
                let previewButton = '';
                if (file.contentType && file.contentType.startsWith('audio/')) {
                    previewButton = `<button onclick="playAudio('${fileId}')" class="btn btn-primary btn-sm" style="margin-right: 5px;">üéµ Dinle</button>`;
                } else if (file.contentType && file.contentType.startsWith('video/')) {
                    previewButton = `<button onclick="playVideo('${fileId}')" class="btn btn-primary btn-sm" style="margin-right: 5px;">üé• ƒ∞zle</button>`;
                } else if (file.contentType && file.contentType.startsWith('image/')) {
                    previewButton = `<button onclick="previewImage('${fileId}')" class="btn btn-primary btn-sm" style="margin-right: 5px;">üñºÔ∏è G√∂r√ºnt√ºle</button>`;
                }

                tableHtml += `
                    <tr>
                        <td>${file.filename || 'Bilinmiyor'}</td>
                        <td>${file.contentType || 'Bilinmiyor'}</td>
                        <td>${size}</td>
                        <td><code style="font-size: 11px;">${fileId}</code></td>
                        <td>
                            <a href="${fileUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 12px;">
                                ${fileUrl}
                            </a>
                            <button onclick="copyToClipboard('${fileUrl}')" style="margin-left: 5px; padding: 2px 8px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">Kopyala</button>
                        </td>
                        <td>${uploadDate}</td>
                        <td>
                            ${previewButton}
                            <button onclick="deleteFile('${fileId}')" class="btn btn-danger btn-sm">Sil</button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            document.getElementById('filesTable').innerHTML = tableHtml;

            // Pagination
            if (pagination) {
                let paginationHtml = '';
                if (pagination.pages > 1) {
                    paginationHtml += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadFiles(${pagination.page - 1})">√ñnceki</button>`;
                    paginationHtml += `<span>Sayfa ${pagination.page} / ${pagination.pages}</span>`;
                    paginationHtml += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadFiles(${pagination.page + 1})">Sonraki</button>`;
                }
                document.getElementById('filesPagination').innerHTML = paginationHtml;
            }
        }

        function openFileUploadModal(context = 'question') {
            currentFileSelectContext = context;
            document.getElementById('fileUploadModal').style.display = 'block';
            document.getElementById('fileUploadForm').reset();
            document.getElementById('fileUploadModalAlert').innerHTML = '';
        }

        function closeFileUploadModal() {
            document.getElementById('fileUploadModal').style.display = 'none';
            document.getElementById('fileUploadForm').reset();
            document.getElementById('fileUploadModalAlert').innerHTML = '';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('filesAlert', 'URL kopyalandƒ±!', 'success');
            }).catch(err => {
                console.error('Kopyalama hatasƒ±:', err);
            });
        }

        async function deleteFile(fileId) {
            if (!confirm('Bu dosyayƒ± silmek istediƒüinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`${FILE_API_BASE}/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('filesAlert', 'Dosya ba≈üarƒ±yla silindi!', 'success');
                    loadFiles();
                } else {
                    showAlert('filesAlert', data.message || 'Dosya silinemedi', 'error');
                }
            } catch (error) {
                console.error('Dosya silme hatasƒ±:', error);
                showAlert('filesAlert', 'Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // DOSYA SE√áME VE √áOKLU MEDYA Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        let allFilesList = []; // T√ºm dosyalarƒ±n listesi

        async function openFileSelectModal(context = 'question') {
            currentFileSelectContext = context;
            document.getElementById('fileSelectModal').style.display = 'block';
            await loadFilesForSelect();
        }

        function closeFileSelectModal() {
            document.getElementById('fileSelectModal').style.display = 'none';
            document.getElementById('fileSearchInput').value = '';
        }

        async function loadFilesForSelect() {
            try {
                const response = await fetch(`${FILE_API_BASE}?page=1&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    allFilesList = data.files;
                    renderFileSelectList(data.files);
                } else {
                    document.getElementById('fileSelectList').innerHTML = `<div class="alert alert-error">${data.message || 'Dosyalar y√ºklenemedi'}</div>`;
                }
            } catch (error) {
                console.error('Dosya y√ºkleme hatasƒ±:', error);
                document.getElementById('fileSelectList').innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        function renderFileSelectList(files) {
            if (!files || files.length === 0) {
                document.getElementById('fileSelectList').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>Hen√ºz dosya y√ºklenmemi≈ü.</p>
                        <button onclick="closeFileSelectModal(); openFileUploadModal();" class="btn btn-primary" style="margin-top: 10px;">Yeni Dosya Y√ºkle</button>
                    </div>
                `;
                return;
            }

            let listHtml = '<div style="display: grid; gap: 10px;">';
            
            files.forEach(file => {
                const fileId = file._id || file.fileId;
                const fileUrl = `${window.location.origin}/api/files/${fileId}`;
                const sizeKB = (file.length / 1024).toFixed(2);
                const sizeMB = (file.length / 1024 / 1024).toFixed(2);
                const size = file.length > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;
                const uploadDate = file.uploadDate ? new Date(file.uploadDate).toLocaleString('tr-TR') : 'Bilinmiyor';
                
                // Dosya tipine g√∂re ikon
                let icon = 'üìÑ';
                if (file.contentType) {
                    if (file.contentType.startsWith('image/')) icon = 'üñºÔ∏è';
                    else if (file.contentType.startsWith('video/')) icon = 'üé•';
                    else if (file.contentType.startsWith('audio/')) icon = 'üéµ';
                }

                listHtml += `
                    <div class="file-select-item" data-filename="${file.filename.toLowerCase()}" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.borderColor='#667eea'; this.style.backgroundColor='#f5f7fa';" 
                         onmouseout="this.style.borderColor='#e0e0e0'; this.style.backgroundColor='white';"
                         onclick="selectFileForQuestion('${fileId}', '${file.contentType || ''}')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">${file.filename}</div>
                                <div style="font-size: 12px; color: #666;">
                                    <span>${file.contentType || 'Bilinmiyor'}</span> ‚Ä¢ 
                                    <span>${size}</span> ‚Ä¢ 
                                    <span>${uploadDate}</span>
                                </div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px; font-family: monospace;">
                                    ID: ${fileId}
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); selectFileForQuestion('${fileId}', '${file.contentType || ''}')">Se√ß</button>
                        </div>
                    </div>
                `;
            });

            listHtml += '</div>';
            document.getElementById('fileSelectList').innerHTML = listHtml;
        }

        function filterFiles() {
            const searchTerm = document.getElementById('fileSearchInput').value.toLowerCase();
            const filteredFiles = allFilesList.filter(file => 
                file.filename.toLowerCase().includes(searchTerm) ||
                (file.contentType && file.contentType.toLowerCase().includes(searchTerm))
            );
            renderFileSelectList(filteredFiles);
        }

        function selectFileForQuestion(fileId, contentType) {
            // Medya tipini belirle
            let mediaType = 'Image';
            if (contentType) {
                if (contentType.startsWith('image/')) {
                    mediaType = 'Image';
                } else if (contentType.startsWith('video/')) {
                    mediaType = 'Video';
                } else if (contentType.startsWith('audio/')) {
                    mediaType = 'Audio';
                }
            }
            
            // Yeni: Resim veya ses dosyasƒ± i√ßin √∂zel i≈ülem
            if (currentFileSelectContext === 'question-image') {
                if (mediaType !== 'Image') {
                    showAlert('fileSelectModalAlert', 'L√ºtfen bir resim dosyasƒ± se√ßin!', 'error');
                    return;
                }
                selectedImageFile = {
                    fileId: fileId,
                    mediaType: 'Image',
                    contentType: contentType || ''
                };
                renderSelectedImageFile();
                closeFileSelectModal();
                showAlert('questionModalAlert', '‚úÖ Resim eklendi!', 'success');
                return;
            }
            
            if (currentFileSelectContext === 'question-audio') {
                if (mediaType !== 'Audio') {
                    showAlert('fileSelectModalAlert', 'L√ºtfen bir ses dosyasƒ± se√ßin!', 'error');
                    return;
                }
                selectedAudioFile = {
                    fileId: fileId,
                    mediaType: 'Audio',
                    contentType: contentType || ''
                };
                renderSelectedAudioFile();
                closeFileSelectModal();
                showAlert('questionModalAlert', '‚úÖ Ses dosyasƒ± eklendi!', 'success');
                return;
            }
            
            if (currentFileSelectContext === 'question-video') {
                if (mediaType !== 'Video') {
                    showAlert('fileSelectModalAlert', 'L√ºtfen bir video dosyasƒ± se√ßin!', 'error');
                    return;
                }
                selectedVideoFile = {
                    fileId: fileId,
                    mediaType: 'Video',
                    contentType: contentType || ''
                };
                renderSelectedVideoFile();
                closeFileSelectModal();
                showAlert('questionModalAlert', '‚úÖ Video dosyasƒ± eklendi!', 'success');
                return;
            }
            
            // Eski sistem (geriye uyumluluk i√ßin)
            // Context'e g√∂re doƒüru array'i se√ß
            let targetArray, storageElementId, alertElementId;
            if (currentFileSelectContext === 'activity') {
                targetArray = selectedActivityMediaFiles;
                storageElementId = 'activityMediaStorage';
                alertElementId = 'activityModalAlert';
            } else if (currentFileSelectContext === 'lesson') {
                targetArray = selectedLessonMediaFiles;
                storageElementId = 'lessonMediaStorage';
                alertElementId = 'lessonModalAlert';
            } else if (currentFileSelectContext === 'group') {
                targetArray = selectedGroupMediaFiles;
                storageElementId = 'groupMediaStorage';
                alertElementId = 'groupModalAlert';
            } else {
                targetArray = selectedMediaFiles;
                storageElementId = 'questionMediaStorage';
                alertElementId = 'questionModalAlert';
            }
            
            // Dosya zaten se√ßili mi kontrol et
            const exists = targetArray.find(f => f.fileId === fileId);
            if (exists) {
                showAlert('fileSelectModalAlert', 'Bu dosya zaten se√ßili!', 'error');
                return;
            }
            
            // Dosyayƒ± listeye ekle
            targetArray.push({
                fileId: fileId,
                mediaType: mediaType,
                contentType: contentType || ''
            });
            
            // Listeyi g√ºncelle
            if (currentFileSelectContext === 'activity') {
                renderSelectedActivityMediaFiles();
            } else if (currentFileSelectContext === 'lesson') {
                renderSelectedLessonMediaFiles();
            } else if (currentFileSelectContext === 'group') {
                renderSelectedGroupMediaFiles();
            } else {
                renderSelectedMediaFiles();
            }
            
            // Medya depolama tipini GridFS olarak ayarla
            const storageEl = document.getElementById(storageElementId);
            if (storageEl) storageEl.value = 'GridFS';
            
            // Modal'ƒ± kapat
            closeFileSelectModal();
            
            // Ba≈üarƒ± mesajƒ± g√∂ster
            const alertEl = document.getElementById(alertElementId);
            if (alertEl) {
                showAlert(alertElementId, `‚úÖ Dosya eklendi! (${targetArray.length} dosya se√ßili)`, 'success');
            }
        }

        function removeMediaFile(index, context = 'question') {
            if (context === 'activity') {
                selectedActivityMediaFiles.splice(index, 1);
                renderSelectedActivityMediaFiles();
                showAlert('activityModalAlert', 'Dosya kaldƒ±rƒ±ldƒ±', 'info');
            } else if (context === 'lesson') {
                selectedLessonMediaFiles.splice(index, 1);
                renderSelectedLessonMediaFiles();
                showAlert('lessonModalAlert', 'Dosya kaldƒ±rƒ±ldƒ±', 'info');
            } else if (context === 'group') {
                selectedGroupMediaFiles.splice(index, 1);
                renderSelectedGroupMediaFiles();
                showAlert('groupModalAlert', 'Dosya kaldƒ±rƒ±ldƒ±', 'info');
            } else {
                selectedMediaFiles.splice(index, 1);
                renderSelectedMediaFiles();
                showAlert('questionModalAlert', 'Dosya kaldƒ±rƒ±ldƒ±', 'info');
            }
        }

        function renderSelectedMediaFiles() {
            const container = document.getElementById('selectedMediaFiles');
            if (container) {
                if (selectedMediaFiles.length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">Hen√ºz dosya se√ßilmedi</div>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 10px;">';
                selectedMediaFiles.forEach((file, index) => {
                    let icon = 'üìÑ';
                    if (file.mediaType === 'Image') icon = 'üñºÔ∏è';
                    else if (file.mediaType === 'Video') icon = 'üé•';
                    else if (file.mediaType === 'Audio') icon = 'üéµ';
                    
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f5f7fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <span style="font-size: 24px;">${icon}</span>
                                <div>
                                    <div style="font-weight: 600;">${file.mediaType}</div>
                                    <div style="font-size: 11px; color: #666; font-family: monospace;">ID: ${file.fileId}</div>
                                </div>
                            </div>
                            <button onclick="removeMediaFile(${index}, 'question')" class="btn btn-danger btn-sm" style="padding: 5px 10px;">‚úï Kaldƒ±r</button>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }
        
        // Resim dosyasƒ± render
        function renderSelectedImageFile() {
            const container = document.getElementById('selectedImageFile');
            if (!container) return;
            
            if (!selectedImageFile) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">Hen√ºz resim se√ßilmedi</div>';
                return;
            }
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f5f7fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-size: 24px;">üñºÔ∏è</span>
                        <div>
                            <div style="font-weight: 600;">Resim</div>
                            <div style="font-size: 11px; color: #666; font-family: monospace;">ID: ${selectedImageFile.fileId}</div>
                        </div>
                    </div>
                    <button onclick="removeImageFile()" class="btn btn-danger btn-sm" style="padding: 5px 10px;">‚úï Kaldƒ±r</button>
                </div>
            `;
        }
        
        // Ses dosyasƒ± render
        function renderSelectedAudioFile() {
            const container = document.getElementById('selectedAudioFile');
            if (!container) return;
            
            if (!selectedAudioFile) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">Hen√ºz ses dosyasƒ± se√ßilmedi</div>';
                return;
            }
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f5f7fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-size: 24px;">üéµ</span>
                        <div>
                            <div style="font-weight: 600;">Ses</div>
                            <div style="font-size: 11px; color: #666; font-family: monospace;">ID: ${selectedAudioFile.fileId}</div>
                        </div>
                    </div>
                    <button onclick="removeAudioFile()" class="btn btn-danger btn-sm" style="padding: 5px 10px;">‚úï Kaldƒ±r</button>
                </div>
            `;
        }
        
        // Video dosyasƒ± render
        function renderSelectedVideoFile() {
            const container = document.getElementById('selectedVideoFile');
            if (!container) return;
            
            if (!selectedVideoFile) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">Hen√ºz video dosyasƒ± se√ßilmedi</div>';
                return;
            }
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f5f7fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-size: 24px;">üé•</span>
                        <div>
                            <div style="font-weight: 600;">Video</div>
                            <div style="font-size: 11px; color: #666; font-family: monospace;">ID: ${selectedVideoFile.fileId}</div>
                        </div>
                    </div>
                    <button onclick="removeVideoFile()" class="btn btn-danger btn-sm" style="padding: 5px 10px;">‚úï Kaldƒ±r</button>
                </div>
            `;
        }
        
        // Resim dosyasƒ± se√ß
        function openFileSelectModalForImage() {
            currentFileSelectContext = 'question-image';
            document.getElementById('fileSelectModal').style.display = 'block';
            loadFilesForSelect();
        }
        
        function openFileUploadModalForImage() {
            currentFileSelectContext = 'question-image';
            document.getElementById('fileUploadModal').style.display = 'block';
        }
        
        // Ses dosyasƒ± se√ß
        function openFileSelectModalForAudio() {
            currentFileSelectContext = 'question-audio';
            document.getElementById('fileSelectModal').style.display = 'block';
            loadFilesForSelect();
        }
        
        function openFileUploadModalForAudio() {
            currentFileSelectContext = 'question-audio';
            document.getElementById('fileUploadModal').style.display = 'block';
        }
        
        // Video dosyasƒ± se√ß
        function openFileSelectModalForVideo() {
            currentFileSelectContext = 'question-video';
            document.getElementById('fileSelectModal').style.display = 'block';
            loadFilesForSelect();
        }
        
        function openFileUploadModalForVideo() {
            currentFileSelectContext = 'question-video';
            document.getElementById('fileUploadModal').style.display = 'block';
        }
        
        // Resim dosyasƒ± kaldƒ±r
        function removeImageFile() {
            selectedImageFile = null;
            renderSelectedImageFile();
            showAlert('questionModalAlert', 'Resim kaldƒ±rƒ±ldƒ±', 'info');
        }
        
        // Ses dosyasƒ± kaldƒ±r
        function removeAudioFile() {
            selectedAudioFile = null;
            renderSelectedAudioFile();
            showAlert('questionModalAlert', 'Ses dosyasƒ± kaldƒ±rƒ±ldƒ±', 'info');
        }
        
        // Video dosyasƒ± kaldƒ±r
        function removeVideoFile() {
            selectedVideoFile = null;
            renderSelectedVideoFile();
            showAlert('questionModalAlert', 'Video dosyasƒ± kaldƒ±rƒ±ldƒ±', 'info');
        }

        // ======================================================================
        // DOSYA √ñNƒ∞ZLEME (Ses, Video, Resim)
        // ======================================================================

        function playAudio(fileId) {
            const fileUrl = `${window.location.origin}/api/files/${fileId}`;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>üéµ Ses Dosyasƒ±</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        <audio controls autoplay style="width: 100%;">
                            <source src="${fileUrl}" type="audio/mpeg">
                            <source src="${fileUrl}" type="audio/wav">
                            <source src="${fileUrl}" type="audio/mp3">
                            Tarayƒ±cƒ±nƒ±z ses dosyasƒ±nƒ± desteklemiyor.
                        </audio>
                        <div style="margin-top: 15px;">
                            <a href="${fileUrl}" download style="color: #667eea; text-decoration: none;">üì• ƒ∞ndir</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function playVideo(fileId) {
            const fileUrl = `${window.location.origin}/api/files/${fileId}`;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üé• Video Dosyasƒ±</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div style="padding: 20px;">
                        <video controls autoplay style="width: 100%; max-height: 70vh;">
                            <source src="${fileUrl}" type="video/mp4">
                            Tarayƒ±cƒ±nƒ±z video dosyasƒ±nƒ± desteklemiyor.
                        </video>
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="${fileUrl}" download style="color: #667eea; text-decoration: none;">üì• ƒ∞ndir</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function previewImage(fileId) {
            const fileUrl = `${window.location.origin}/api/files/${fileId}`;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üñºÔ∏è Resim √ñnizleme</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        <img src="${fileUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;" alt="Resim">
                        <div style="margin-top: 15px;">
                            <a href="${fileUrl}" download style="color: #667eea; text-decoration: none;">üì• ƒ∞ndir</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }
        // ======================================================================
        // ƒ∞STATƒ∞STƒ∞KLER
        // ======================================================================

        let currentStatisticsStudentId = null;
        let currentStatisticsTeacherId = null;

        async function loadStatistics() {
            try {
                // √ñƒüretmen listesini y√ºkle
                await loadTeachersForStatistics();
                
                // √ñƒüretmen se√ßimi deƒüi≈ütiƒüinde
                const teacherSelect = document.getElementById('statisticsTeacherSelect');
                const studentSelect = document.getElementById('statisticsStudentSelect');
                const periodSelect = document.getElementById('statisticsPeriodSelect');
                
                if (teacherSelect) {
                    teacherSelect.addEventListener('change', async function() {
                        currentStatisticsTeacherId = this.value;
                        currentStatisticsStudentId = null;
                        
                        if (currentStatisticsTeacherId) {
                            // √ñƒürenci dropdown'ƒ±nƒ± aktif et ve √∂ƒürencileri y√ºkle
                            studentSelect.disabled = false;
                            studentSelect.innerHTML = '<option value="">Y√ºkleniyor...</option>';
                            await loadStudentsForStatistics(currentStatisticsTeacherId);
                        } else {
                            // √ñƒürenci dropdown'ƒ±nƒ± devre dƒ±≈üƒ± bƒ±rak
                            studentSelect.disabled = true;
                            studentSelect.innerHTML = '<option value="">√ñnce √∂ƒüretmen se√ßin...</option>';
                            document.getElementById('statisticsContent').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">L√ºtfen √∂nce √∂ƒüretmen, sonra √∂ƒürenci se√ßin</p>';
                        }
                    });
                }
                
                if (studentSelect) {
                    studentSelect.addEventListener('change', function() {
                        currentStatisticsStudentId = this.value;
                        if (currentStatisticsStudentId) {
                            loadStudentStatistics();
                        } else {
                            document.getElementById('statisticsContent').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">L√ºtfen bir √∂ƒürenci se√ßin</p>';
                        }
                    });
                }
                
                if (periodSelect) {
                    periodSelect.addEventListener('change', function() {
                        if (currentStatisticsStudentId) {
                            loadStudentStatistics();
                        }
                    });
                }
            } catch (error) {
                console.error('ƒ∞statistikler y√ºklenemedi:', error);
                showAlert('statisticsAlert', 'ƒ∞statistikler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        async function loadTeachersForStatistics() {
            try {
                const response = await fetch(`${API_BASE}/teachers`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const teacherSelect = document.getElementById('statisticsTeacherSelect');
                    if (!teacherSelect) return;
                    
                    teacherSelect.innerHTML = '<option value="">√ñƒüretmen se√ßin...</option>';
                    
                    data.data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id || teacher._id;
                        option.textContent = teacher.fullName || `${teacher.firstName} ${teacher.lastName}`;
                        teacherSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('√ñƒüretmenler y√ºklenemedi:', error);
                showAlert('statisticsAlert', '√ñƒüretmenler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        async function loadStudentsForStatistics(teacherId) {
            try {
                // √ñƒüretmenin sƒ±nƒ±flarƒ±nƒ± getir
                const response = await fetch(`${API_BASE}/teachers/${teacherId}/classrooms`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const studentSelect = document.getElementById('statisticsStudentSelect');
                if (!studentSelect) return;
                
                studentSelect.innerHTML = '<option value="">√ñƒürenci se√ßin...</option>';
                
                if (data.success && data.classrooms && data.classrooms.length > 0) {
                    // T√ºm sƒ±nƒ±flardaki √∂ƒürencileri topla
                    const allStudents = [];
                    data.classrooms.forEach(classroom => {
                        if (classroom.students && classroom.students.length > 0) {
                            classroom.students.forEach(student => {
                                // Duplicate kontrol√º
                                const studentId = student._id?.toString() || student.id?.toString() || student.toString();
                                if (!allStudents.find(s => s.id === studentId)) {
                                    allStudents.push({
                                        id: studentId,
                                        name: `${student.firstName || ''} ${student.lastName || ''}`.trim(),
                                        classroom: classroom.name
                                    });
                                }
                            });
                        }
                    });
                    
                    if (allStudents.length === 0) {
                        studentSelect.innerHTML = '<option value="">Bu √∂ƒüretmenin √∂ƒürencisi bulunamadƒ±</option>';
                    } else {
                        allStudents.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.name} (${student.classroom})`;
                            studentSelect.appendChild(option);
                        });
                    }
                } else {
                    studentSelect.innerHTML = '<option value="">Bu √∂ƒüretmenin √∂ƒürencisi bulunamadƒ±</option>';
                }
            } catch (error) {
                console.error('√ñƒürenciler y√ºklenemedi:', error);
                showAlert('statisticsAlert', '√ñƒürenciler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        async function loadStudentStatistics() {
            if (!currentStatisticsStudentId) return;
            
            try {
                const periodSelect = document.getElementById('statisticsPeriodSelect');
                const period = periodSelect ? periodSelect.value : 'daily';
                
                // Admin panelinde √∂ƒüretmen ID'sini query parametresi olarak g√∂nder
                const teacherIdParam = currentStatisticsTeacherId ? `&teacherId=${currentStatisticsTeacherId}` : '';
                const url = `${API_BASE}/statistics/teacher/student/${currentStatisticsStudentId}?period=${period}${teacherIdParam}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    renderStatistics(data);
                } else {
                    showAlert('statisticsAlert', data.message || 'ƒ∞statistikler y√ºklenemedi', 'error');
                }
            } catch (error) {
                console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error);
                showAlert('statisticsAlert', 'Hata: ' + error.message, 'error');
            }
        }

        function renderStatistics(data) {
            const container = document.getElementById('statisticsContent');
            if (!container) return;
            
            const formatTime = (seconds) => {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                if (hours > 0) return `${hours}sa ${minutes}dk ${secs}sn`;
                if (minutes > 0) return `${minutes}dk ${secs}sn`;
                return `${secs}sn`;
            };
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px;">${data.student.firstName} ${data.student.lastName} - ƒ∞statistikler</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Uygulamada Ge√ßirilen S√ºre</div>
                            <div style="font-size: 24px; font-weight: 600; color: #4CAF50;">${formatTime(data.dailyStatistics.totalTimeSpent)}</div>
                        </div>
                        ${data.dailyStatistics.totalReadingTime > 0 ? `
                        <div style="background: #fff4e6; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Okuma S√ºresi</div>
                            <div style="font-size: 24px; font-weight: 600; color: #ff9800;">${formatTime(data.dailyStatistics.totalReadingTime)}</div>
                        </div>
                        ` : ''}
                        ${data.dailyStatistics.averageReadingSpeed > 0 ? `
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Okuma Hƒ±zƒ±</div>
                            <div style="font-size: 24px; font-weight: 600; color: #9c27b0;">${data.dailyStatistics.averageReadingSpeed.toFixed(1)} kelime/dk</div>
                        </div>
                        ` : ''}
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Tamamlanan Aktivite</div>
                            <div style="font-size: 24px; font-weight: 600; color: #4CAF50;">${data.dailyStatistics.completedActivities}</div>
                        </div>
                    </div>
            `;
            
            // Haftalƒ±k √∂zet varsa g√∂ster
            if (data.weeklySummary) {
                html += `
                    <div style="background: #f5f7fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">üìÖ Haftalƒ±k √ñzet (Son 7 G√ºn)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div>
                                <div style="font-size: 11px; color: #666;">Toplam S√ºre</div>
                                <div style="font-weight: 600;">${formatTime(data.weeklySummary.totalTimeSpent)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666;">Toplam Okuma</div>
                                <div style="font-weight: 600;">${formatTime(data.weeklySummary.totalReadingTime)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666;">Toplam Aktivite</div>
                                <div style="font-weight: 600;">${data.weeklySummary.totalCompletedActivities}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666;">Aktif G√ºn</div>
                                <div style="font-weight: 600;">${data.weeklySummary.daysWithActivity} g√ºn</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Tamamlanan dersler (yeni format)
            const completedLessons = data.dailyStatistics.completedLessons || {};
            const activitiesByCategory = data.dailyStatistics.activitiesByCategory || {}; // Geriye d√∂n√ºk uyumluluk
            
            if (Object.keys(completedLessons).length > 0) {
                html += '<h4 style="margin-bottom: 15px;">üìñ Tamamlanan Dersler</h4>';
                Object.values(completedLessons).forEach((lesson, lessonIndex) => {
                    const averageScore = lesson.activityCount > 0 
                        ? Math.round((lesson.totalScore / lesson.activityCount) * 100) / 100 
                        : 0;
                    html += `
                        <div style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <h5 style="color: #4CAF50; margin-bottom: 10px;">üìñ ${lesson.title}</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 12px; color: #666;">Tamamlanan Aktivite</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #4CAF50;">${lesson.activityCount}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">Ortalama Puan</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #4CAF50;">${averageScore}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">Toplam Puan</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #4CAF50;">${lesson.totalScore}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else if (Object.keys(activitiesByCategory).length > 0) {
                // Geriye d√∂n√ºk uyumluluk: Eski format (kategori bazlƒ±)
                html += '<h4 style="margin-bottom: 15px;">üìö Tamamlanan Aktiviteler</h4>';
                Object.entries(activitiesByCategory).forEach(([categoryName, activities]) => {
                    html += `
                        <div style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #4CAF50; margin-bottom: 10px;">${categoryName} (${activities.length} aktivite)</h5>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #4CAF50; color: white;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Aktivite</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Puan</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Okuma S√ºresi</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Okuma Hƒ±zƒ±</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    activities.forEach(activity => {
                        const readingTime = activity.readingTime ? formatTime(activity.readingTime) : '-';
                        const readingSpeed = activity.readingSpeed ? `${activity.readingSpeed.toFixed(1)} kelime/dk` : '-';
                        html += `
                            <tr>
                                <td style="padding: 10px; border: 1px solid #ddd;">${activity.title}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${activity.score}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${readingTime}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${readingSpeed}</td>
                            </tr>
                        `;
                    });
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
            }
            
            // Email g√∂nderme b√∂l√ºm√º
            html += `
                    <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-radius: 8px; border: 1px solid #4CAF50;">
                        <h4 style="margin-bottom: 15px;">üìß Veliye Email G√∂nder</h4>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Veli Email Adresi:</label>
                            <input type="email" id="parentEmailInput" value="${data.student.parentEmail || ''}" 
                                   placeholder="veli@example.com" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        </div>
                        <button class="btn btn-success" onclick="sendStatisticsEmail('${data.student.id}')" style="width: 100%;">
                            üìß Email G√∂nder
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function sendStatisticsEmail(studentId) {
            const emailInput = document.getElementById('parentEmailInput');
            const email = emailInput ? emailInput.value.trim() : '';
            
            if (!email) {
                showAlert('statisticsAlert', 'L√ºtfen veli email adresini giriniz', 'error');
                return;
            }
            
            // Email formatƒ±nƒ± kontrol et
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('statisticsAlert', 'Ge√ßerli bir email adresi giriniz', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/statistics/student/${studentId}/send-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ parentEmail: email })
                });
                
                const data = await response.json();
                
                console.log('üìß Email g√∂nderme yanƒ±tƒ±:', data);
                console.log('üìß HTTP Status:', response.status);
                
                if (data.success) {
                    showAlert('statisticsAlert', '‚úÖ Email ba≈üarƒ±yla g√∂nderildi!', 'success');
                } else {
                    const errorMsg = data.message || 'Email g√∂nderilemedi';
                    console.error('‚ùå Email g√∂nderme hatasƒ±:', errorMsg);
                    showAlert('statisticsAlert', '‚ùå ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('‚ùå Email g√∂nderme hatasƒ±:', error);
                showAlert('statisticsAlert', 'Hata: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // √ñƒûRETMEN NOTLARI
        // ======================================================================

        let currentTeacherNotesStudentId = null;
        let currentTeacherNotesTeacherId = null;
        let currentNoteId = null;

        async function loadTeacherNotes() {
            try {
                // √ñƒüretmen listesini y√ºkle
                await loadTeachersForTeacherNotes();
                
                // √ñƒüretmen se√ßimi deƒüi≈ütiƒüinde
                const teacherSelect = document.getElementById('teacherNotesTeacherSelect');
                const studentSelect = document.getElementById('teacherNotesStudentSelect');
                
                if (teacherSelect) {
                    teacherSelect.addEventListener('change', async function() {
                        currentTeacherNotesTeacherId = this.value;
                        currentTeacherNotesStudentId = null;
                        
                        if (currentTeacherNotesTeacherId) {
                            // √ñƒürenci dropdown'ƒ±nƒ± aktif et ve √∂ƒürencileri y√ºkle
                            studentSelect.disabled = false;
                            studentSelect.innerHTML = '<option value="">Y√ºkleniyor...</option>';
                            await loadStudentsForTeacherNotes(currentTeacherNotesTeacherId);
                        } else {
                            // √ñƒürenci dropdown'ƒ±nƒ± devre dƒ±≈üƒ± bƒ±rak
                            studentSelect.disabled = true;
                            studentSelect.innerHTML = '<option value="">√ñnce √∂ƒüretmen se√ßin...</option>';
                            document.getElementById('teacherNotesContent').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">L√ºtfen √∂nce √∂ƒüretmen, sonra √∂ƒürenci se√ßin</p>';
                        }
                    });
                }
                
                if (studentSelect) {
                    studentSelect.addEventListener('change', function() {
                        currentTeacherNotesStudentId = this.value;
                        if (currentTeacherNotesStudentId) {
                            loadStudentTeacherNotes();
                        } else {
                            document.getElementById('teacherNotesContent').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">L√ºtfen bir √∂ƒürenci se√ßin</p>';
                        }
                    });
                }
            } catch (error) {
                console.error('√ñƒüretmen notlarƒ± y√ºklenemedi:', error);
                showAlert('teacherNotesAlert', '√ñƒüretmen notlarƒ± y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        async function loadTeachersForTeacherNotes() {
            try {
                const response = await fetch(`${API_BASE}/users?role=Teacher&limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const teacherSelect = document.getElementById('teacherNotesTeacherSelect');
                    if (!teacherSelect) return;
                    
                    teacherSelect.innerHTML = '<option value="">√ñƒüretmen se√ßin...</option>';
                    
                    data.data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher._id || teacher.id;
                        option.textContent = `${teacher.firstName} ${teacher.lastName}`;
                        teacherSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('√ñƒüretmenler y√ºklenemedi:', error);
            }
        }

        async function loadStudentsForTeacherNotes(teacherId) {
            try {
                // √ñƒüretmenin sƒ±nƒ±flarƒ±nƒ± getir (t√ºm sayfalarƒ± almak i√ßin limit artƒ±r)
                const response = await fetch(`${API_BASE}/classrooms?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const studentSelect = document.getElementById('teacherNotesStudentSelect');
                if (!studentSelect) return;
                
                studentSelect.innerHTML = '<option value="">√ñƒürenci se√ßin...</option>';
                
                if (data.success && data.data && data.data.length > 0) {
                    // Sadece se√ßilen √∂ƒüretmenin sƒ±nƒ±flarƒ±ndaki √∂ƒürencileri filtrele
                    const allStudents = [];
                    data.data.forEach(classroom => {
                        // √ñƒüretmen ID'sini kontrol et (populate edilmi≈ü veya ObjectId olabilir)
                        const classroomTeacherId = classroom.teacher?._id?.toString() || classroom.teacher?.toString() || classroom.teacher;
                        const targetTeacherId = teacherId.toString();
                        
                        if (classroomTeacherId === targetTeacherId) {
                            if (classroom.students && classroom.students.length > 0) {
                                classroom.students.forEach(student => {
                                    // Duplicate kontrol√º
                                    const studentId = student._id?.toString() || student.id?.toString() || student.toString();
                                    if (!allStudents.find(s => s.id === studentId)) {
                                        allStudents.push({
                                            id: studentId,
                                            name: `${student.firstName || ''} ${student.lastName || ''}`.trim(),
                                            classroom: classroom.name
                                        });
                                    }
                                });
                            }
                        }
                    });
                    
                    if (allStudents.length === 0) {
                        studentSelect.innerHTML = '<option value="">Bu √∂ƒüretmenin √∂ƒürencisi bulunamadƒ±</option>';
                    } else {
                        allStudents.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.name} (${student.classroom})`;
                            studentSelect.appendChild(option);
                        });
                    }
                } else {
                    studentSelect.innerHTML = '<option value="">√ñƒürenci bulunamadƒ±</option>';
                }
            } catch (error) {
                console.error('√ñƒürenciler y√ºklenemedi:', error);
                showAlert('teacherNotesAlert', '√ñƒürenciler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        async function loadStudentTeacherNotes() {
            if (!currentTeacherNotesStudentId) return;
            
            try {
                // √ñnce son √ßalƒ±≈üma verisini y√ºkle
                let lastSessionData = null;
                try {
                    const lastSessionResponse = await fetch(
                        `${API_BASE}/teacher-notes/student/${currentTeacherNotesStudentId}/last-session`,
                        { headers: { 'Authorization': `Bearer ${currentToken}` } }
                    );
                    const lastSessionResult = await lastSessionResponse.json();
                    if (lastSessionResult.success) {
                        lastSessionData = lastSessionResult.lastSession;
                    }
                } catch (error) {
                    console.error('Son √ßalƒ±≈üma verisi y√ºklenemedi:', error);
                }
                
                // Admin panelinden √ßaƒürƒ±ldƒ±ƒüƒ±nda √∂ƒüretmen ID'sini query parametresi olarak g√∂nder
                const url = currentTeacherNotesTeacherId 
                    ? `${API_BASE}/teacher-notes/student/${currentTeacherNotesStudentId}?teacherId=${currentTeacherNotesTeacherId}`
                    : `${API_BASE}/teacher-notes/student/${currentTeacherNotesStudentId}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    renderTeacherNotes(data, lastSessionData);
                } else {
                    showAlert('teacherNotesAlert', data.message || 'Notlar y√ºklenemedi', 'error');
                }
            } catch (error) {
                console.error('Not y√ºkleme hatasƒ±:', error);
                showAlert('teacherNotesAlert', 'Hata: ' + error.message, 'error');
            }
        }

        function renderTeacherNotes(data, lastSessionData = null) {
            const container = document.getElementById('teacherNotesContent');
            if (!container) return;
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px;">${data.student.firstName} ${data.student.lastName} - √ñƒüretmen Notlarƒ±</h3>
            `;
            
            // üí° VERƒ∞TABANI OPTƒ∞Mƒ∞ZASYONU: Son √áalƒ±≈üma ƒ∞statistikleri B√∂l√ºm√º
            if (lastSessionData && lastSessionData.activities && lastSessionData.activities.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            <span>üìä Son √áalƒ±≈üma</span>
                        </h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: 600;">Toplam S√ºre:</span>
                                <span style="font-size: 18px; font-weight: bold;">${lastSessionData.totalDurationFormatted || '0sn'}</span>
                            </div>
                            ${lastSessionData.sessionStartTime ? `
                                <div style="font-size: 12px; opacity: 0.9;">
                                    Ba≈ülangƒ±√ß: ${new Date(lastSessionData.sessionStartTime).toLocaleString('tr-TR')}
                                </div>
                            ` : ''}
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">Tamamlanan Aktiviteler:</div>
                            <div style="display: grid; gap: 8px;">
                                ${lastSessionData.activities.map((activity, index) => `
                                    <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>${index + 1}. ${activity.activityTitle || 'Bilinmeyen Aktivite'}</span>
                                        <span style="font-weight: 600;">${activity.durationFormatted || '0sn'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <strong>Son √áalƒ±≈üma:</strong> Hen√ºz √ßalƒ±≈üma kaydƒ± bulunmamaktadƒ±r.
                    </div>
                `;
            }
            
            // Not Ekleme B√∂l√ºm√º
            html += `
                <div style="background: #f0f7ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #4CAF50;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìù Yeni Not Ekle</h4>
                    <form id="quickNoteForm" onsubmit="saveQuickTeacherNote(event)" style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Not ƒ∞√ßeriƒüi *</label>
                            <textarea id="quickNoteContent" required rows="4" 
                                      placeholder="√ñƒürenci hakkƒ±nda notunuzu buraya yazƒ±n..."
                                      style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">√ñncelik</label>
                                <select id="quickNotePriority" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="Normal">Normal</option>
                                    <option value="√ñnemli">√ñnemli</option>
                                    <option value="Acil">Acil</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Kategori</label>
                                <input type="text" id="quickNoteCategory" value="Genel" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 16px; font-weight: 600;">
                            üíæ Notu Kaydet
                        </button>
                    </form>
                </div>
            `;
            
            // Mevcut Notlar B√∂l√ºm√º
            html += '<h4 style="margin: 20px 0 15px 0; color: #2c3e50;">üìã Mevcut Notlar</h4>';
            
            if (data.notes && data.notes.length > 0) {
                html += '<div style="display: grid; gap: 15px;">';
                data.notes.forEach(note => {
                    const priorityColors = {
                        'Normal': '#4CAF50',
                        '√ñnemli': '#ff9800',
                        'Acil': '#f44336'
                    };
                    const priorityColor = priorityColors[note.priority] || '#4CAF50';
                    
                    html += `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid ${priorityColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0;">${note.title}</h4>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                        ${note.category || 'Genel'} | 
                                        <span style="color: ${priorityColor}; font-weight: 600;">${note.priority}</span> | 
                                        ${new Date(note.createdAt).toLocaleDateString('tr-TR')}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-primary btn-sm" onclick="editTeacherNote('${note.id}')">‚úèÔ∏è D√ºzenle</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTeacherNote('${note.id}')">üóëÔ∏è Sil</button>
                                </div>
                            </div>
                            <div style="color: #333; line-height: 1.6;">${note.content}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center; padding: 40px;">Hen√ºz not eklenmemi≈ü</p>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Hƒ±zlƒ± not ekleme fonksiyonu
        async function saveQuickTeacherNote(event) {
            event.preventDefault();
            
            if (!currentTeacherNotesStudentId) {
                showAlert('teacherNotesAlert', 'L√ºtfen √∂nce bir √∂ƒürenci se√ßin', 'error');
                return;
            }
            
            const content = document.getElementById('quickNoteContent').value.trim();
            const priority = document.getElementById('quickNotePriority').value;
            const category = document.getElementById('quickNoteCategory').value.trim() || 'Genel';
            
            if (!content) {
                showAlert('teacherNotesAlert', 'L√ºtfen not i√ßeriƒüini giriniz', 'error');
                return;
            }
            
            // Otomatik ba≈ülƒ±k olu≈ütur (tarih + kategori)
            const title = `${category} - ${new Date().toLocaleDateString('tr-TR')}`;
            
            try {
                const url = `${API_BASE}/teacher-notes/student/${currentTeacherNotesStudentId}`;
                const bodyData = {
                    title: title,
                    content: content,
                    priority: priority,
                    category: category
                };
                
                if (currentTeacherNotesTeacherId) {
                    bodyData.teacherId = currentTeacherNotesTeacherId;
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('teacherNotesAlert', data.message || 'Not kaydedildi', 'success');
                    // Formu temizle
                    document.getElementById('quickNoteForm').reset();
                    document.getElementById('quickNoteCategory').value = 'Genel';
                    // Notlarƒ± yenile
                    await loadStudentTeacherNotes();
                } else {
                    showAlert('teacherNotesAlert', data.message || 'Not kaydedilemedi', 'error');
                }
            } catch (error) {
                console.error('Not kaydetme hatasƒ±:', error);
                showAlert('teacherNotesAlert', 'Hata: ' + error.message, 'error');
            }
        }

        function openTeacherNoteModal(noteId = null) {
            currentNoteId = noteId;
            
            // √ñƒüretmen se√ßilmemi≈üse uyarƒ± ver
            if (!currentTeacherNotesTeacherId) {
                showAlert('teacherNotesAlert', 'L√ºtfen √∂nce bir √∂ƒüretmen se√ßin', 'error');
                return;
            }
            
            const modal = document.getElementById('teacherNoteModal');
            if (!modal) {
                // Modal olu≈ütur
                createTeacherNoteModal();
            }
            const modalElement = document.getElementById('teacherNoteModal');
            if (modalElement) {
                modalElement.classList.add('active');
                if (noteId) {
                    loadTeacherNoteData(noteId);
                } else {
                    document.getElementById('teacherNoteForm').reset();
                    document.getElementById('teacherNoteModalTitle').textContent = 'Yeni Not';
                    // Yeni not modunda, √∂ƒürenci listesini y√ºkle
                    loadStudentsForNoteModal();
                }
            }
        }

        function createTeacherNoteModal() {
            const modal = document.createElement('div');
            modal.id = 'teacherNoteModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 id="teacherNoteModalTitle">Yeni Not</h2>
                        <span class="close" onclick="closeTeacherNoteModal()">&times;</span>
                    </div>
                    <div id="teacherNoteModalAlert"></div>
                    <form id="teacherNoteForm" onsubmit="saveTeacherNote(event)">
                        <div style="margin-bottom: 15px;">
                            <label>√ñƒürenci *</label>
                            <select id="teacherNoteStudentSelect" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">√ñƒürenci se√ßin...</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Not Ba≈ülƒ±ƒüƒ± *</label>
                            <input type="text" id="teacherNoteTitle" required maxlength="200" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Not ƒ∞√ßeriƒüi *</label>
                            <textarea id="teacherNoteContent" required rows="5" 
                                      style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>√ñncelik</label>
                            <select id="teacherNotePriority" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="Normal">Normal</option>
                                <option value="√ñnemli">√ñnemli</option>
                                <option value="Acil">Acil</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Kategori</label>
                            <input type="text" id="teacherNoteCategory" value="Genel" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn" onclick="closeTeacherNoteModal()" style="flex: 1; background: #e0e0e0;">ƒ∞ptal</button>
                            <button type="submit" class="btn btn-success" style="flex: 1;">Kaydet</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // √ñƒürenci listesini y√ºkle
            loadStudentsForNoteModal();
        }

        async function loadStudentsForNoteModal() {
            try {
                // Eƒüer √∂ƒüretmen se√ßilmi≈üse, sadece o √∂ƒüretmenin √∂ƒürencilerini g√∂ster
                if (!currentTeacherNotesTeacherId) {
                    const studentSelect = document.getElementById('teacherNoteStudentSelect');
                    if (studentSelect) {
                        studentSelect.innerHTML = '<option value="">√ñnce √∂ƒüretmen se√ßin...</option>';
                    }
                    return;
                }
                
                const response = await fetch(`${API_BASE}/classrooms?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const studentSelect = document.getElementById('teacherNoteStudentSelect');
                if (!studentSelect) return;
                
                studentSelect.innerHTML = '<option value="">√ñƒürenci se√ßin...</option>';
                
                if (data.success && data.data && data.data.length > 0) {
                    // Sadece se√ßilen √∂ƒüretmenin sƒ±nƒ±flarƒ±ndaki √∂ƒürencileri filtrele
                    const allStudents = [];
                    data.data.forEach(classroom => {
                        // √ñƒüretmen ID'sini kontrol et (populate edilmi≈ü veya ObjectId olabilir)
                        const classroomTeacherId = classroom.teacher?._id?.toString() || classroom.teacher?.toString() || classroom.teacher;
                        const targetTeacherId = currentTeacherNotesTeacherId.toString();
                        
                        if (classroomTeacherId === targetTeacherId) {
                            if (classroom.students && classroom.students.length > 0) {
                                classroom.students.forEach(student => {
                                    // Duplicate kontrol√º
                                    const studentId = student._id?.toString() || student.id?.toString() || student.toString();
                                    if (!allStudents.find(s => s.id === studentId)) {
                                        allStudents.push({
                                            id: studentId,
                                            name: `${student.firstName || ''} ${student.lastName || ''}`.trim(),
                                            classroom: classroom.name
                                        });
                                    }
                                });
                            }
                        }
                    });
                    
                    if (allStudents.length === 0) {
                        studentSelect.innerHTML = '<option value="">Bu √∂ƒüretmenin √∂ƒürencisi bulunamadƒ±</option>';
                    } else {
                        allStudents.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.name} (${student.classroom})`;
                            studentSelect.appendChild(option);
                        });
                    }
                } else {
                    studentSelect.innerHTML = '<option value="">√ñƒürenci bulunamadƒ±</option>';
                }
            } catch (error) {
                console.error('√ñƒürenciler y√ºklenemedi:', error);
            }
        }

        async function saveTeacherNote(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('teacherNoteStudentSelect').value;
            const title = document.getElementById('teacherNoteTitle').value.trim();
            const content = document.getElementById('teacherNoteContent').value.trim();
            const priority = document.getElementById('teacherNotePriority').value;
            const category = document.getElementById('teacherNoteCategory').value.trim() || 'Genel';
            
            if (!studentId) {
                showAlert('teacherNoteModalAlert', 'L√ºtfen bir √∂ƒürenci se√ßin', 'error');
                return;
            }
            
            try {
                const url = currentNoteId 
                    ? `${API_BASE}/teacher-notes/${currentNoteId}`
                    : `${API_BASE}/teacher-notes/student/${studentId}`;
                const method = currentNoteId ? 'PUT' : 'POST';
                
                // Admin panelinden √ßaƒürƒ±ldƒ±ƒüƒ±nda √∂ƒüretmen ID'sini de g√∂nder
                const bodyData = {
                    title,
                    content,
                    priority,
                    category
                };
                
                if (currentTeacherNotesTeacherId && !currentNoteId) {
                    bodyData.teacherId = currentTeacherNotesTeacherId;
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('teacherNoteModalAlert', data.message || 'Not kaydedildi', 'success');
                    setTimeout(() => {
                        closeTeacherNoteModal();
                        if (currentTeacherNotesStudentId === studentId) {
                            loadStudentTeacherNotes();
                        }
                    }, 1000);
                } else {
                    showAlert('teacherNoteModalAlert', data.message || 'Not kaydedilemedi', 'error');
                }
            } catch (error) {
                console.error('Not kaydetme hatasƒ±:', error);
                showAlert('teacherNoteModalAlert', 'Hata: ' + error.message, 'error');
            }
        }

        async function editTeacherNote(noteId) {
            currentNoteId = noteId;
            openTeacherNoteModal(noteId);
        }

        async function loadTeacherNoteData(noteId) {
            try {
                // Not verilerini y√ºkle (√∂ƒürenci notlarƒ± listesinden alƒ±nabilir)
                // ≈ûimdilik modal'ƒ± a√ßƒ±p kullanƒ±cƒ±nƒ±n d√ºzenlemesine izin ver
                document.getElementById('teacherNoteModalTitle').textContent = 'Not D√ºzenle';
            } catch (error) {
                console.error('Not y√ºkleme hatasƒ±:', error);
            }
        }

        async function deleteTeacherNote(noteId) {
            if (!confirm('Bu notu silmek istediƒüinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/teacher-notes/${noteId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('teacherNotesAlert', 'Not ba≈üarƒ±yla silindi', 'success');
                    if (currentTeacherNotesStudentId) {
                        loadStudentTeacherNotes();
                    }
                } else {
                    showAlert('teacherNotesAlert', data.message || 'Not silinemedi', 'error');
                }
            } catch (error) {
                console.error('Not silme hatasƒ±:', error);
                showAlert('teacherNotesAlert', 'Hata: ' + error.message, 'error');
            }
        }

        function closeTeacherNoteModal() {
            const modal = document.getElementById('teacherNoteModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentNoteId = null;
            document.getElementById('teacherNoteForm').reset();
            document.getElementById('teacherNoteModalAlert').innerHTML = '';
        }

        // ======================================================================
        // OKUMA METNƒ∞ Y√ñNETƒ∞Mƒ∞
        // ======================================================================

        function toggleReadingTextFields() {
            const activityType = document.getElementById('activityActivityType')?.value || document.getElementById('activityType')?.value;
            const readingFields = document.getElementById('readingTextFields');
            const durationField = document.getElementById('readingDurationField');
            
            if (activityType === 'Text') {
                if (readingFields) readingFields.style.display = 'block';
                if (durationField) durationField.style.display = 'block';
            } else {
                if (readingFields) readingFields.style.display = 'none';
                if (durationField) durationField.style.display = 'none';
            }
        }

        function addTextLine() {
            const container = document.getElementById('textLinesContainer');
            if (!container) return;
            
            const lineDiv = document.createElement('div');
            lineDiv.className = 'text-line-item';
            lineDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px;';
            lineDiv.innerHTML = `
                <input type="text" class="text-line-input" placeholder="√ñrn: Ahmet yaptƒ±." style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeTextLine(this)" style="padding: 8px 12px;">‚úï</button>
            `;
            container.appendChild(lineDiv);
        }

        function removeTextLine(button) {
            const container = document.getElementById('textLinesContainer');
            if (container && button.parentElement) {
                button.parentElement.remove();
            }
        }

        function getTextLines() {
            const inputs = document.querySelectorAll('#textLinesContainer .text-line-input');
            const lines = [];
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    lines.push(value);
                }
            });
            return lines;
        }

        // Activity modal a√ßƒ±ldƒ±ƒüƒ±nda okuma metni alanlarƒ±nƒ± kontrol et
        const originalOpenActivityModal = window.openActivityModal;
        if (typeof originalOpenActivityModal === 'function') {
            window.openActivityModal = function(activityId) {
                originalOpenActivityModal(activityId);
                setTimeout(() => {
                    toggleReadingTextFields();
                }, 100);
            };
        }

    </script>
</body>
</html>
